<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>lynnyq</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-03-10T07:08:53.566Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>lynnyq</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/03/10/hello-world/"/>
    <id>http://yoursite.com/2019/03/10/hello-world/</id>
    <published>2019-03-10T07:08:53.566Z</published>
    <updated>2019-03-10T07:08:53.566Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/Centos7.2%E4%B8%8ACDH5.15.1%E4%B8%AD%E5%90%AF%E7%94%A8Kerberos/"/>
    <id>http://yoursite.com/2019/02/16/Centos7.2上CDH5.15.1中启用Kerberos/</id>
    <published>2019-02-16T15:32:13.122Z</published>
    <updated>2019-02-16T15:32:13.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Centos7-2上CDH5-15-1中启用Kerberos"><a href="#Centos7-2上CDH5-15-1中启用Kerberos" class="headerlink" title="Centos7.2上CDH5.15.1中启用Kerberos"></a>Centos7.2上CDH5.15.1中启用Kerberos</h2><h3 id="1-KDC服务安装及配置"><a href="#1-KDC服务安装及配置" class="headerlink" title="1.KDC服务安装及配置"></a>1.KDC服务安装及配置</h3><ul><li>下载KDC服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install krb5-server krb5-libs krb5-auth-dialog krb5-workstation</span><br></pre></td></tr></table></figure><ul><li>修改/etc/krb5.conf配置 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/krb5.conf</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration snippets may be placed in this directory as well</span></span><br><span class="line">includedir /etc/krb5.conf.d/</span><br><span class="line"></span><br><span class="line">[logging]</span><br><span class="line"> default = FILE:/var/<span class="built_in">log</span>/krb5libs.log</span><br><span class="line"> kdc = FILE:/var/<span class="built_in">log</span>/krb5kdc.log</span><br><span class="line"> admin_server = FILE:/var/<span class="built_in">log</span>/kadmind.log</span><br><span class="line"></span><br><span class="line">[libdefaults]</span><br><span class="line"> dns_lookup_realm = <span class="literal">false</span></span><br><span class="line"> ticket_lifetime = 24h</span><br><span class="line"> renew_lifetime = 7d</span><br><span class="line"> forwardable = <span class="literal">true</span></span><br><span class="line"> rdns = <span class="literal">false</span></span><br><span class="line"> default_realm = BELLE.COM.CN</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"> BELLE.COM.CN = &#123;</span><br><span class="line">  kdc = bi-cdh-dev-m-001</span><br><span class="line">  admin_server = bi-cdh-dev-m-001</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">[domain_realm]</span><br><span class="line"> .bi-cdh-dev-m-001 = BELLE.COM.CN</span><br><span class="line"> bi-cdh-dev-m-001 = BELLE.COM.CN</span><br></pre></td></tr></table></figure><ul><li>修改/var/kerberos/krb5kdc/kadm5.acl配置 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /var/kerberos/krb5kdc/kadm5.acl</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/admin@BELLE.COM.CN    *</span><br></pre></td></tr></table></figure><ul><li>修改/var/kerberos/krb5kdc/kdc.conf </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /var/kerberos/krb5kdc/kdc.conf</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[kdcdefaults]</span><br><span class="line"> kdc_ports = 88</span><br><span class="line"> kdc_tcp_ports = 88</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"> BELLE.COM.CN = &#123;</span><br><span class="line">  <span class="comment">#master_key_type = aes256-cts</span></span><br><span class="line">  max_renewable_life= 7d 0h 0m 0s</span><br><span class="line">  acl_file = /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">  dict_file = /usr/share/dict/words</span><br><span class="line">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</span><br><span class="line">  supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal camellia256-cts:normal camellia128-cts:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>创建Kerberos数据库 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kdb5_util create -r BELLE.COM.CN -s</span><br></pre></td></tr></table></figure><p><strong>此处需要输入Kerberos数据库的密码</strong> </p><ul><li>创建Kerberos的管理账号 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local</span><br><span class="line"></span><br><span class="line">Authenticating as principal root/admin@BELLE.COM.CN with password.</span><br><span class="line">kadmin.local:  addprinc admin/admin@BELLE.COM.CN</span><br><span class="line">WARNING: no policy specified <span class="keyword">for</span> admin/admin@BELLE.COM.CN; defaulting to no policy</span><br><span class="line">Enter password <span class="keyword">for</span> principal <span class="string">"admin/admin@BELLE.COM.CN"</span>: </span><br><span class="line">Re-enter password <span class="keyword">for</span> principal <span class="string">"admin/admin@BELLE.COM.CN"</span>: </span><br><span class="line">Principal <span class="string">"admin/admin@BELLE.COM.CN"</span> created.</span><br><span class="line">kadmin.local:  <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><ul><li>将Kerberos服务添加到自启动服务，并启动krb5kdc和kadmin服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> krb5kdc</span><br><span class="line">systemctl <span class="built_in">enable</span> kadmin</span><br><span class="line">systemctl start krb5kdc</span><br><span class="line">systemctl start kadmin</span><br></pre></td></tr></table></figure><ul><li>测试Kerberos的管理员账号 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@bi-cdh-dev-m-001 ~]<span class="comment">#  kinit admin/admin@BELLE.COM.CN</span></span><br><span class="line">Password <span class="keyword">for</span> admin/admin@BELLE.COM.CN: </span><br><span class="line">[root@bi-cdh-dev-m-001 ~]<span class="comment"># klist </span></span><br><span class="line">Ticket cache: FILE:/tmp/krb5cc_0</span><br><span class="line">Default principal: admin/admin@BELLE.COM.CN</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">10/24/2018 20:54:59  10/25/2018 20:54:59  krbtgt/BELLE.COM.CN@BELLE.COM.CN</span><br><span class="line">renew until 10/31/2018 20:54:59</span><br></pre></td></tr></table></figure><ul><li>为集群安装所有Kerberos客户端，包括Cloudera Manager</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install krb5-libs krb5-workstation</span><br></pre></td></tr></table></figure><ul><li>在Cloudera Manager Server服务器上安装额外的包 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openldap-clients</span><br></pre></td></tr></table></figure><ul><li>将KDC Server上的krb5.conf文件拷贝到所有Kerberos客户端 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/krb5.conf bi-cdh-dev-w-001:/etc/</span><br><span class="line">scp /etc/krb5.conf bi-cdh-dev-w-002:/etc/</span><br></pre></td></tr></table></figure><h2 id="2-CDH集群启用Kerberos"><a href="#2-CDH集群启用Kerberos" class="headerlink" title="2.CDH集群启用Kerberos"></a>2.CDH集群启用Kerberos</h2><ul><li>在KDC中给Cloudera Manager添加管理员账号 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local</span><br><span class="line"></span><br><span class="line">Authenticating as principal root/BELLE.COM.CN with password.</span><br><span class="line">kadmin.local:  addprinc cloudera-scm/admin@BELLE.COM.CN</span><br><span class="line">WARNING: no policy specified <span class="keyword">for</span> cloudera-scm/admin@BELLE.COM.CN; defaulting to no policy</span><br><span class="line">Enter password <span class="keyword">for</span> principal <span class="string">"cloudera-scm/admin@BELLE.COM.CN"</span>: </span><br><span class="line">Re-enter password <span class="keyword">for</span> principal <span class="string">"cloudera-scm/admin@BELLE.COM.CN"</span>: </span><br><span class="line">Principal <span class="string">"cloudera-scm/admin@BELLE.COM.CN"</span> created.</span><br><span class="line">kadmin.local:  <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><ul><li>管理-安全</li></ul><p><img src="images/kerbores/01.png" alt></p><ul><li>启用Kerberos</li></ul><p><img src="images/kerbores/02.png" alt></p><ul><li>确保列出的所有检查项都已完成 </li><li>点击“继续”，配置相关的KDC信息，Kerberos安全领域、KDC Sever主机名、KDC Admin  Sever主机名</li><li>不建议让Cloudera Manager来管理krb5.conf, 点击“继续” </li><li>输入Cloudera Manager的Kerbers管理员账号，一定得和之前创建的账号一致，点击“继续” </li><li>点击“继续”启用Kerberos </li><li>勾选重启集群，点击“继续” </li><li>集群重启完成，点击“继续” </li><li>点击“继续” </li><li>点击“完成”，至此已成功启用Kerberos。 </li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Centos7-2上CDH5-15-1中启用Kerberos&quot;&gt;&lt;a href=&quot;#Centos7-2上CDH5-15-1中启用Kerberos&quot; class=&quot;headerlink&quot; title=&quot;Centos7.2上CDH5.15.1中启用Kerberos&quot;&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/Flume/Flume%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2019/02/16/Flume/Flume学习笔记/</id>
    <published>2019-02-16T15:32:13.122Z</published>
    <updated>2019-02-16T15:32:13.122Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Flume笔记"><a href="#Flume笔记" class="headerlink" title="Flume笔记"></a>Flume笔记</h1><p>[TOC]</p><h2 id="1-Flume概述"><a href="#1-Flume概述" class="headerlink" title="1.Flume概述"></a>1.Flume概述</h2><p>​    Flume NG是一个分布式，高可用，可靠的系统，它能将不同的海量数据收集，移动并存储到一个数据存储系统中。轻量，配置简单，适用于各种日志收集，并支持Failover和负载均衡。并且它拥有非常丰富的组件。Flume NG采用的是三层架构：Agent层，Collector层和Store层，每一层均可水平拓展。其中Agent包含Source，Channel和Sink，三者组建了一个Agent。三者的职责如下所示： </p><ul><li><strong>Source：</strong>用来消费（收集）数据源到Channel组件中</li><li><strong>Channel：</strong>中转临时存储，保存所有Source组件信息</li><li><strong>Sink：</strong>从Channel中读取，读取成功后会删除Channel中的信息</li></ul><p>下图是Flume NG的架构图：</p><p><img src="images/01.png" alt="架构图"> </p><h2 id="2-Flume介绍"><a href="#2-Flume介绍" class="headerlink" title="2.Flume介绍"></a>2.Flume介绍</h2><p>Flume用户手册：<a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeUserGuide.html</a></p><p>Flume开发者手册：<a href="http://flume.apache.org/FlumeDeveloperGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeDeveloperGuide.html</a></p><h3 id="2-1-Flume采集系统结构图"><a href="#2-1-Flume采集系统结构图" class="headerlink" title="2.1.Flume采集系统结构图"></a>2.1.Flume采集系统结构图</h3><ul><li>简单结构：单个agent采集数据</li></ul><p><img src="images/02.png" alt="单个agent"></p><ul><li>复杂结构：多级agent之间串联</li></ul><p><img src="images/03.png" alt="多级agent"></p><ul><li>高可用Flume NG集群 ：</li></ul><p><img src="images/04.png" alt="Flume NG集群"></p><p><code>Flume的存储可以支持多种，这里只列举了HDFS和Kafka（如：存储最新的一周日志，并给Storm系统提供实时日志流）</code></p><h3 id="2-2-Flume-Sources"><a href="#2-2-Flume-Sources" class="headerlink" title="2.2.Flume Sources"></a>2.2.Flume Sources</h3><p>参考：</p><p><a href="https://www.cnblogs.com/swordfall/p/8254271.html" target="_blank" rel="noopener">https://www.cnblogs.com/swordfall/p/8254271.html</a></p><p><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeUserGuide.html</a></p><h4 id="2-2-1-Flume-Sources-类型"><a href="#2-2-1-Flume-Sources-类型" class="headerlink" title="2.2.1.Flume Sources 类型"></a>2.2.1.Flume Sources 类型</h4><p>官网文档上要求的属性是粗体字。</p><ul><li><p><strong>1.Avro Source:</strong></p><p>监听Avro端口，从Avro client streams接收events。 </p></li><li><p><strong>2.Thrift Source：</strong></p><p>监听Thrift端口和从外部Thrift client streams接收events。 </p></li><li><p><strong>3.Exec Source:</strong></p><p>Exec Source在启动时运行一个Unix命令行，并期望这过程在标准输出上连续生产数据。 </p></li><li><p><strong>4.JMS Source：</strong></p><p>JMS Source从JMS目标（如队列或者主题）读取消息。JMS应用程序应该可以与任何JMS提供程序一起工作，但是只能使用ActiveMQ进行测试。 </p></li><li><p><strong>5.Spooling Directory Source:</strong></p><p>该source让你通过放置被提取文件在磁盘”spooling“目录下这一方式，提取数据。该source将会监控指定目录的新增文件，当新文件出现时解析event。event解析逻辑是可插入的。当一个给定文件被全部读取进channel之后，它被重命名，以标识为已完成（或者可选择deleted）。 </p></li><li><p><strong>6.Taildir Source:</strong></p><p>注意：该source不能用于windows。 </p></li><li><p><strong>7.Twitter 1% firehose Source(试验):</strong></p></li><li><p><strong>8.Kafka Source:</strong></p><p>Kafka Source是Apache Kafka消费者，从Kfaka topics读取消息。如果你有多个Kafka source在跑，你可以配置它们在相同的Consumer Group，以使它们每个读取topics独特的分区。 </p></li><li><p><strong>9.NetCat TCP Source:</strong></p><p>netcat source监听一个给定的端口，然后把text文件的每一行转换成一个event。要求属性是粗体字。 </p></li><li><p><strong>10.NetCat UDP Source:</strong></p><p>netcat source监听一个给定的端口，然后把text文件的每一行转换成一个event。 </p></li><li><p><strong>11.Sequence Generator Source:</strong></p><p>一个简单的序列生成器可以不断生成events，带有counter计数器，从0开始，以1递增，在totalEvents停止。当不能发送events到channels时会不断尝试。 </p></li><li><p><strong>12.Syslog Sources:</strong></p><p>读取系统日志，并生成Flume events。UDP source以整条消息作为一个简单event。TCP source以新一行”n“分割的字符串作为一个新的event。 </p><ul><li><strong>Syslog TCP Source :</strong><code>原始的，可靠的Syslog TCP source。</code></li><li><strong>Multiport Syslog TCP Source:</strong><code>这是一个新的，更快的，多端口的Syslog TCP source版本。注意ports配置替代port。</code></li><li><strong>Syslog UDP Source:</strong></li></ul></li><li><p><strong>13.HTTP Source:</strong></p><p>source 通过HTTP POST 和 GET，接收Flume events。GET只能用于试验。HTTP requests通过 必须实现 HTTPSourceHandler接口的 ”handler“ 转换成flume events。该handler获取HttpServletRequest，然后返回一系列的flume events。 </p></li><li><p><strong>14.Stress Source:</strong></p><p>StressSource 是内部负载生成source的实现，这对于压力测试是非常有用的。它允许用户配置Event有效载荷的大小。 </p></li><li><p><strong>15.Legacy Sources:</strong></p><p>Legacy sources允许Flume 1.x agent接收来自Flume 0.9.4 agents的events。legacy source 支持Avro和Thrift RPC 连接。为了使用两个Flume 版本搭建的桥梁，你需要开始一个带有avroLegacy或者thriftLegacy source的Flume 1.x agent。0.9.4agent应该有agent Sink指向1.x agent的host/port。</p><ul><li>Avro Legacy Source</li><li>Thrift Legacy Source</li></ul></li><li><p><strong>16.Custom Source(自定义Source):</strong></p><p>自定义Source是你实现Source接口。当启动Flume agent时，一个自定义source类和它依赖项必须在agent的classpath中。 </p></li><li><p><strong>17.Scrible Source:</strong></p><p>Scribe是另一种类型的提取系统。采用现有的Scribe提取系统，Flume应该使用基于Thrift的兼容传输协议的ScribeSource。 </p></li></ul><h3 id="2-3-Flume-Sinks"><a href="#2-3-Flume-Sinks" class="headerlink" title="2.3.Flume Sinks"></a>2.3.Flume Sinks</h3><p>参考：</p><p><a href="http://www.cnblogs.com/swordfall/p/8157766.html" target="_blank" rel="noopener">http://www.cnblogs.com/swordfall/p/8157766.html</a></p><p><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeUserGuide.html</a></p><h4 id="2-3-1-Flume-Sinks-类型"><a href="#2-3-1-Flume-Sinks-类型" class="headerlink" title="2.3.1.Flume Sinks 类型"></a>2.3.1.Flume Sinks 类型</h4><ul><li><strong>HDFS Sink:</strong> <code>该sink把events写进Hadoop分布式文件系统（HDFS）。它目前支持创建文本和序列文件。它支持在两种文件类型压缩。文件可以基于数据的经过时间或者大小或者事件的数量周期性地滚动。它还通过属性（如时间戳或发生事件的机器）把数据划分为桶或区。</code></li><li><strong>Hive Sink:</strong> <code>该sink streams 将包含分割文本或者JSON数据的events直接传送到Hive表或分区中。使用Hive 事务写events。当一系列events提交到Hive时，它们马上可以被Hive查询到。</code></li><li><strong>Logger Sink:</strong> <code>Logs event 在INFO 水平。典型用法是测试或者调试。</code></li><li><strong>Avro Sink:</strong> <code>Flume events发送到sink，转换为Avro events，并发送到配置好的hostname/port。从配置好的channel按照配置好的批量大小批量获取events。</code></li><li><strong>Thrift Sink:</strong> <code>Flume events发送到sink，转换为Thrift events，并发送到配置好的hostname/port。从配置好的channel按照配置好的批量大小批量获取events。</code></li><li><strong>IRC Sink:</strong> <code>IRC sink从链接的channel获取消息和推送消息到配置的IRC目的地。</code></li><li><strong>File Roll Sink:</strong> <code>在本地文件系统存储events。</code></li><li><strong>Null Sink:</strong> <code>当接收到channel时丢弃所有events。</code></li><li><strong>HBaseSinks:</strong> <code>该sink写数据到HBase。</code></li><li><strong>AsyncHBaseSink:</strong> <code>该sink采用异步模式写数据到HBase。</code></li><li><strong>MorphlineSolrSink:</strong> <code>该sink从Flume events提取数据并转换，在Apache Solr 服务端实时加载，Apache Solr servers为最终用户或者搜索应用程序提供查询服务。</code></li><li><strong>ElasticSearchSink:</strong> <code>该sink写数据到elasticsearch集群。</code></li><li><strong>Kite Dataset Sink:</strong> <code>试验sink写event到Kite Dataset。</code></li><li><strong>Kafka Sink:</strong> <code>Flume Sink实现可以导出数据到一个Kafka topic。</code></li><li><strong>HTTP Sink:</strong> <code>该sink将会从channel获取events，并使用HTTP POST请求发送这些events到远程服务。event 内容作为POST body发送。</code></li><li><strong>Custom Sink:</strong> <code>自定义sink是你实现Sink接口。当启动Flume agent时，一个自定义sink类和它依赖项必须在agent的classpath中。</code></li></ul><h4 id="2-3-2-Flume-Sink-Processors"><a href="#2-3-2-Flume-Sink-Processors" class="headerlink" title="2.3.2.Flume Sink Processors"></a>2.3.2.Flume Sink Processors</h4><p>​    Sinks groups 允许用户把多个sinks分组汇入到一个实体中。Sink processors可以用于在组内所有sinks提供负载平衡，或者在暂时失败的情况下实现从一个sink到另一个sink的故障转移。 </p><ul><li><p><strong>Default Sink Processor</strong></p><p>​    默认sink processor只接收一个简单sink。用户没有强制去为单个sinks创建processor(sink group)。相反，用户可以按照用户指南上解释的source - channel - sink 模式。 </p></li><li><p><strong>Failover Sink Processor</strong></p><p>​    Failover Sink Processor 维护sinks的优先列表，保证当有可用的events将会被处理。 </p></li><li><p><strong>Load balancing Sink Processor</strong></p><p>​    Load balancing sink processor 提供了对多个sinks进行负载平衡的能力。 </p></li></ul><h4 id="2-3-3-Event-Serializers"><a href="#2-3-3-Event-Serializers" class="headerlink" title="2.3.3.Event Serializers"></a>2.3.3.Event Serializers</h4><p>file_roll sink和hdfs sink都支持EventSerializer接口。下面提供了Flume附带的EventSerializers的细节。 </p><ul><li><p><strong>Body Text Serializer</strong></p><p>别名：text。拦截器将event的主体写入输出流，而没进行任何的转换或者修改。event header被忽略。配置选项： </p></li><li><p><strong>“Flume Event” Avro Event Serializer</strong></p><p>别名：avro_event。</p><p>拦截器将Flume events序列化成一个Avro容器文件。所使用的模式与Avro RPC机制中用于Flume events的模式相同。</p><p>该serializer继承自AbstractAvroEventSerializer类。</p></li><li><p><strong>Avro Event Serializer</strong></p><p>别名：该serializer没有别名，必须指定使用的类名。 </p></li></ul><h3 id="2-4-Flume-Channel"><a href="#2-4-Flume-Channel" class="headerlink" title="2.4. Flume Channel"></a>2.4. Flume Channel</h3><p>参考：</p><p><a href="http://www.cnblogs.com/swordfall/p/8169554.html" target="_blank" rel="noopener">http://www.cnblogs.com/swordfall/p/8169554.html</a></p><p><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeUserGuide.html</a></p><h4 id="2-4-1-Flume-Channel-类型"><a href="#2-4-1-Flume-Channel-类型" class="headerlink" title="2.4.1. Flume Channel 类型"></a>2.4.1. Flume Channel 类型</h4><ul><li><p><strong>Memory Channel（内存Channels）</strong></p><p>​    events存储在配置最大大小的内存队列中。对于流量较高和由于agent故障而准备丢失数据的流程来说，这是一个理想的选择。 </p></li><li><p><strong>JDBC Channel</strong></p><p>​    events存储在持久化存储库中（其背后是一个数据库）。JDBC channel目前支持嵌入式Derby。这是一个持续的channel，对于可恢复性非常重要的流程来说是理想的选择。</p></li><li><p><strong>Kafka Channel</strong></p><p>events存储在Kafka集群中。Kafka提供高可用性和高可靠性，所以当agent或者kafka broker 崩溃时，events能马上被其他sinks可用。</p><p>Kafka channel可以被多个场景使用：</p><ol><li>Flume source和sink - 它为events提供可靠和高可用的channel</li><li>Flume source和interceptor，但是没sink - 它允许写Flume evnets到Kafka topic</li><li>Flume sink，但是没source - 这是一种低延迟，容错的方式从Kafka发送events到Flume sinks 例如 HDFS, HBase或者Solr</li></ol></li><li><p><strong>File Channel</strong></p></li><li><p><strong>Spillable Memory Channel</strong></p><p>events存储在内存队列和磁盘中。该channel目前正在试验中，不要求在生产环境中使用。 </p></li><li><p><strong>Pseudo Transaction Channel</strong></p><p>注意：Pseudo Transaction Channel只用于单元测试，不用于生产环境使用。 </p></li><li><p><strong>Custom Channel</strong></p><p>​    自定义channel是你实现Channel接口。当Flume agent启动时，一个自定义channel类和它依赖项必须包含在agent的classpath。</p></li></ul><h4 id="2-4-2-Flume-Channel-Selectors"><a href="#2-4-2-Flume-Channel-Selectors" class="headerlink" title="2.4.2.Flume Channel Selectors"></a>2.4.2.Flume Channel Selectors</h4><p>如果类型没有指定，那么默认“replicating”。 </p><ul><li><p><strong>Replicating Channel Selector(default) (复制channel选择器)</strong></p></li><li><p><strong>Multiplexing Channel Selector （多路复用Channel选择器）</strong></p></li><li><p><strong>Custom Channel Selector (自定义Channel选择器)</strong></p><p>一个自定义channel选择器（selector）是实现ChannelSelector的接口。当Flume agent启动时，一个自定义channel  selector类和它依赖项必须包含在agent的classpath。 </p></li></ul><h3 id="2-5-Flume-Interceptors（拦截器）"><a href="#2-5-Flume-Interceptors（拦截器）" class="headerlink" title="2.5.Flume Interceptors（拦截器）"></a>2.5.Flume Interceptors（拦截器）</h3><p>参考：</p><p><a href="http://www.cnblogs.com/swordfall/p/8207880.html" target="_blank" rel="noopener">http://www.cnblogs.com/swordfall/p/8207880.html</a></p><p><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="noopener">http://flume.apache.org/FlumeUserGuide.html</a></p><p>​    Flume有能力修改/删除流程中的events。这是在拦截器（interceptor）的帮助下完成的。拦截器（Interceptors）是实现org.apache.flume.interceptor.Interceptor接口的类。一个interceptor可以根据interceptor的开发者选择的任何标准来修改，甚至放弃events。这个可以通过在配置中指定一系列interceptor生成类名来实现。Interceptors在source配置中被指定作为空白分隔符列表。如果interceptor需要放弃events，它不会在它需要返回的列表中返回该events。如果interceptor放弃全部events，然后它返回一个空列表。简单示例： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line">a1.sources.r1.interceptors = i1 i2</span><br><span class="line">a1.sources.r1.interceptors.i1.type = org.apache.flume.interceptor.HostInterceptor$Builder</span><br><span class="line">a1.sources.r1.interceptors.i1.preserveExisting = false</span><br><span class="line">a1.sources.r1.interceptors.i1.hostHeader = hostname</span><br><span class="line">a1.sources.r1.interceptors.i2.type = org.apache.flume.interceptor.TimestampInterceptor$Builder</span><br><span class="line">a1.sinks.k1.filePrefix = FlumeData.%&#123;CollectorHost&#125;.%Y-%m-%d</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure><p>​    注意：该interceptor构建是被传递给type配置属性。interceptors本身是可配置的，并且可以像传递给其他可配置组件一样传递配置值。在上述示例中，events先传递到HostInterceptor，并且events被HostInterceptor返回，然后独自传递到TimestampInterceptor。你可以指定完全限定的类名称或者别名 timestamp。如果你有多个收集器写到同一个HDFS路径，然后你也可以使用HostInterceptor。 </p><h4 id="2-5-1-Flume-Interceptors-种类"><a href="#2-5-1-Flume-Interceptors-种类" class="headerlink" title="2.5.1.Flume Interceptors 种类"></a>2.5.1.Flume Interceptors 种类</h4><ul><li><p><strong>Timestamp Interceptor</strong></p><p>该interceptor向event headers插入秒级时间，当event被处理时。该interceptor插入一个带有关键timestamp（或者由header属性指定）的header，其值是相关的timestamp。该interceptors可以保留一个已存在timestamp，如果它已经在配置中预先配置。 </p></li><li><p><strong>Host Interceptor</strong></p><p>该interceptor插入运行agent的host的hostname或者IP地址。它根据配置插入带有密钥host或配置密钥（其值为host的hostname或IP地址）的header。 </p></li><li><p><strong>Static Interceptor</strong></p><p>静态interceptor运行用户给所有events添加一个带有静态值的静态header。 </p></li><li><p><strong>Remove Header Interceptor</strong></p><p>该interceptor通过移除一个或多个headers来操作Flume event headers。它可以移除一个静态定义的header，基于规则表达式的headers或者在一个列表中的headers。如果这些没有定义，或者如果没有header匹配到标准，Flume events将不会修改。</p><p>注意：如果只有一个header需要移除，通过名字指定它可以提供比其他两种方法更好的性能。</p></li><li><p><strong>UUID Interceptor</strong></p><p>该interceptor在被拦截的所有事件上设置一个通用唯一的标识符。 </p></li><li><p><strong>Morphline Interceptor</strong></p><p>该interceptor通过morphline配置文件过滤events，该配置文件定义了一条从一个命令到另一个命令管道记录的转换命令链。例如，morphline可以忽略某些events，或者通过基于正则表达式的模式匹配来改变或者插入某些event headers，或者它可以通过Apache Tika自动检测和设置一个MIME类型在被拦截的events上。 </p></li><li><p><strong>Search and Replace Interceptor</strong></p><p>该interceptor提供了基于Java正则表达式的简单的基于字符串的search-and-replace功能。回溯/组捕获也是可用的。这个interceptor使用与Java Matcher.replaceAll()方法相同的规则。 </p></li><li><p><strong>Regex Flitering Interceptor</strong></p><p>该拦截器通过将event正文解释为文本并将文本与配置的正则表达式进行匹配来选择性地过滤events。 </p></li><li><p><strong>Regex Extractor Interceptor</strong></p><p>此interceptor使用指定的正则表达式提取正则表达式匹配组，并将匹配组附加为event的headers。 </p><p>该serializers用于将匹配映射到header名称和格式化的header值；默认的，你只需要指定header名称和默认org.apache.flume.interceptor.RegexExtractorInterceptorPassThroughSerializer将会被使用。这个serializer只是将匹配映射到指定的header名称，并传递通过由正则表达式提取的值。 </p></li></ul><h2 id="3-Flume安装"><a href="#3-Flume安装" class="headerlink" title="3.Flume安装"></a>3.Flume安装</h2><h3 id="3-1-JDK下载安装"><a href="#3-1-JDK下载安装" class="headerlink" title="3.1.JDK下载安装"></a>3.1.JDK下载安装</h3><ul><li>下载对应版本JavaSDK，下载地址：<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></li><li>解压jdk到/usr/local目录下</li><li>配置环境变量</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在最后面添加如下几行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> jdk</span></span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_171</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使环境变量生效</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="3-2-Flume下载安装"><a href="#3-2-Flume下载安装" class="headerlink" title="3.2.Flume下载安装"></a>3.2.Flume下载安装</h3><ul><li>下载二进制包，下载地址：<a href="http://flume.apache.org/download.html" target="_blank" rel="noopener">http://flume.apache.org/download.html</a></li><li>下载校验文件，文件名*.asc, 下载地址：<a href="http://flume.apache.org/download.html" target="_blank" rel="noopener">http://flume.apache.org/download.html</a></li><li>下载KEYS，地址：<a href="http://www.apache.org/dist/flume/KEYS" target="_blank" rel="noopener">http://www.apache.org/dist/flume/KEYS</a></li><li>校验下载的二进制包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gpg --import KEYS</span><br><span class="line">gpg --verify apache-flume-1.8.0-bin.tar.gz.asc</span><br><span class="line"></span><br><span class="line">gpg: Signature made Fri 15 Sep 2017 09:04:39 PM CST using RSA key ID 4199ACFF</span><br><span class="line">gpg: Good signature from "Denes Arvay &lt;denes@apache.org&gt;"</span><br><span class="line">gpg: WARNING: This key is not certified with a trusted signature!</span><br><span class="line">gpg:          There is no indication that the signature belongs to the owner.</span><br><span class="line">Primary key fingerprint: 4CF1 5CF1 525F CE29 F66C  08FA 302C B2A8 4199 ACFF</span><br></pre></td></tr></table></figure><ul><li>解压二进制包到/usr/local目录下，目录结构如下</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── bin</span><br><span class="line">├── conf</span><br><span class="line">├── lib</span><br><span class="line">├── logs</span><br><span class="line">└── tools</span><br></pre></td></tr></table></figure><ul><li>配置Flume</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp conf/flume-env.sh.template conf/flume-env.sh</span><br><span class="line">vim conf/flume-env.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开这两行注释，改成实际需要的参数</span></span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_171</span><br><span class="line">export JAVA_OPTS="-Xms1024m -Xmx1024m -Dcom.sun.management.jmxremote"</span><br></pre></td></tr></table></figure><h2 id="4-高可用Flume-NG集群搭建-："><a href="#4-高可用Flume-NG集群搭建-：" class="headerlink" title="4.高可用Flume NG集群搭建 ："></a>4.高可用Flume NG集群搭建 ：</h2><p>参考：</p><p><a href="https://www.cnblogs.com/smartloli/p/4468708.html" target="_blank" rel="noopener">https://www.cnblogs.com/smartloli/p/4468708.html</a></p><h3 id="4-1节点分配"><a href="#4-1节点分配" class="headerlink" title="4.1节点分配"></a>4.1节点分配</h3><table><thead><tr><th>名称</th><th>Host</th><th>角色</th></tr></thead><tbody><tr><td>Agent1</td><td>epp-nginx-001v</td><td>Web Server</td></tr><tr><td>Agent2</td><td>epp-nginx-002v</td><td>Web Server</td></tr><tr><td>Collector1</td><td>bi-slave1</td><td>AgentMstr1</td></tr><tr><td>Collector2</td><td>bi-slave2</td><td>AgentMstr2</td></tr></tbody></table><p>Agent1，Agent2数据分别流入到Collector1和Collector2，Flume NG本身提供了Failover机制，可以自动切换和恢复。要把所有的日志都收集到一个集群中存储。</p><h3 id="4-2-配置"><a href="#4-2-配置" class="headerlink" title="4.2.配置"></a>4.2.配置</h3><ul><li>Agent1和Agent2的配置相同：</li></ul><p>flume-client.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1 k2</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.type = taildir</span><br><span class="line">a1.sources.r1.positionFile = /data/logs/flume/taildir_position.json</span><br><span class="line">a1.sources.r1.filegroups = f1</span><br><span class="line">a1.sources.r1.filegroups.f1 = /usr/local/nginx/logs/ecloud.belle.cn.access.log</span><br><span class="line">a1.sources.r1.fileHeader = true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line">a1.sinkgroups = g1 </span><br><span class="line">a1.sinkgroups.g1.sinks = k1 k2</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line">a1.sinks.k1.hostname = bi-slave1</span><br><span class="line">a1.sinks.k1.port = 10000</span><br><span class="line">a1.sinks.k1.batch-size = 1000</span><br><span class="line">a1.sinks.k2.channel = c1</span><br><span class="line">a1.sinks.k2.type = avro</span><br><span class="line">a1.sinks.k2.hostname = bi-slave2</span><br><span class="line">a1.sinks.k2.port = 10000</span><br><span class="line">a1.sinks.k2.batch-size = 1000</span><br><span class="line">a1.sinkgroups.g1.processor.type = failover</span><br><span class="line">a1.sinkgroups.g1.processor.priority.k1 = 10</span><br><span class="line">a1.sinkgroups.g1.processor.priority.k2 = 1</span><br><span class="line">a1.sinkgroups.g1.processor.maxpenalty = 10000</span><br><span class="line"></span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 5000</span><br><span class="line">a1.channels.c1.transactionCapacity = 5000</span><br></pre></td></tr></table></figure><ul><li>Collector1和Collector2下沉到使用kerboros安全认证的CDH集群HDFS中配置</li></ul><p>bi-slave1:  nginxlog.sources.r1.bind = bi-slave1</p><p>bi-slave1:  nginxlog.sources.r1.bind = bi-slave2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">nginxlog.sinks = k1</span><br><span class="line">nginxlog.channels = c1</span><br><span class="line"></span><br><span class="line">nginxlog.sources.r1.channels = c1</span><br><span class="line">nginxlog.sources.r1.type = avro</span><br><span class="line">nginxlog.sources.r1.channels = c1</span><br><span class="line">nginxlog.sources.r1.bind = bi-slave1</span><br><span class="line">nginxlog.sources.r1.port = 10000</span><br><span class="line"></span><br><span class="line">nginxlog.sinks.k1.channel = c1</span><br><span class="line">nginxlog.sinks.k1.type = hdfs</span><br><span class="line">nginxlog.sinks.k1.hdfs.kerberosPrincipal = hdfs/bi-slave1</span><br><span class="line">nginxlog.sinks.k1.hdfs.kerberosKeytab = /usr/flume-keytab/hdfs.keytab</span><br><span class="line">nginxlog.sinks.k1.hdfs.path = /flume/events/%y-%m-%d</span><br><span class="line">nginxlog.sinks.k1.hdfs.filePrefix = events</span><br><span class="line">nginxlog.sinks.k1.hdfs.round = true</span><br><span class="line">nginxlog.sinks.k1.hdfs.roundValue = 24</span><br><span class="line">nginxlog.sinks.k1.hdfs.roundUnit = hour</span><br><span class="line">nginxlog.sinks.k1.hdfs.rollInterval = 600</span><br><span class="line">nginxlog.sinks.k1.hdfs.rollSize = 268435456</span><br><span class="line">nginxlog.sinks.k1.hdfs.rollCount = 2000</span><br><span class="line">nginxlog.sinks.k1.hdfs.batchSize = 1000</span><br><span class="line">nginxlog.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">nginxlog.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line"></span><br><span class="line">nginxlog.channels.c1.type = memory</span><br><span class="line">nginxlog.channels.c1.capacity = 5000</span><br><span class="line">nginxlog.channels.c1.transactionCapacity = 5000</span><br></pre></td></tr></table></figure><ul><li>Collector1和Collector2下沉到使用kerboros安全认证的CDH集群kafka中配置</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">nginxlog.sources = r1</span><br><span class="line">nginxlog.sinks = k1</span><br><span class="line">nginxlog.channels = c1</span><br><span class="line"></span><br><span class="line">nginxlog.sources.r1.channels = c1</span><br><span class="line">nginxlog.sources.r1.type = avro</span><br><span class="line">nginxlog.sources.r1.channels = c1</span><br><span class="line">nginxlog.sources.r1.bind = bi-slave1</span><br><span class="line">nginxlog.sources.r1.port = 10000</span><br><span class="line"></span><br><span class="line">nginxlog.sinks.k1.channel = c1</span><br><span class="line">nginxlog.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSink</span><br><span class="line">nginxlog.sinks.k1.kafka.producer.security.protocol = SASL_PLAINTEXT</span><br><span class="line">nginxlog.sinks.k1.kafka.producer.sasl.kerberos.service.name = kafka</span><br><span class="line">nginxlog.sinks.k1.kafka.producer.group.id = flume-producer</span><br><span class="line">nginxlog.sinks.k1.kafka.topic = nginxlog</span><br><span class="line">nginxlog.sinks.k1.kafka.bootstrap.servers = 172.17.194.17:9092,172.17.194.18:9092,172.17.194.20:9092</span><br><span class="line">nginxlog.sinks.k1.kafka.flumeBatchSize = 1000</span><br><span class="line"></span><br><span class="line">nginxlog.channels.c1.type = memory</span><br><span class="line">nginxlog.channels.c1.capacity = 5000</span><br><span class="line">nginxlog.channels.c1.transactionCapacity = 5000</span><br></pre></td></tr></table></figure><h3 id="4-3-启动"><a href="#4-3-启动" class="headerlink" title="4.3.启动"></a>4.3.启动</h3><ul><li>在Agent节点上启动命令如下所示： </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -c conf -f conf/flume-client.conf -n a1 -Dflume.root.logger=INFO,console &gt;&gt; /data/logs/flume/flume_client.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><ul><li>CDH集群上修改bi-slave1和bi-slave2的配置后重启两个节点</li></ul><h3 id="4-4-Failover测试"><a href="#4-4-Failover测试" class="headerlink" title="4.4.Failover测试"></a>4.4.Failover测试</h3><p>在CDH集群中停止bi-slave1的Flume NG服务，查看bi-slave1、bi-slave2的日志，并检查数据的完整性，结果：bi-slave1服务结束后，flume采集的下沉任务到bi-slave2上了，且数据衔接上了。</p><p>bi-slave1恢复服务后，flume采集的下沉任务又回到了bi-slave1上了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Flume笔记&quot;&gt;&lt;a href=&quot;#Flume笔记&quot; class=&quot;headerlink&quot; title=&quot;Flume笔记&quot;&gt;&lt;/a&gt;Flume笔记&lt;/h1&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;1-Flume概述&quot;&gt;&lt;a href=&quot;#1-Flume概述&quot; 
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/Centos7%E4%B8%8B%E9%83%A8%E7%BD%B2CDH6/"/>
    <id>http://yoursite.com/2019/02/16/Centos7下部署CDH6/</id>
    <published>2019-02-16T15:32:13.122Z</published>
    <updated>2019-02-27T03:18:44.402Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Centos7下部署CDH6"><a href="#Centos7下部署CDH6" class="headerlink" title="Centos7下部署CDH6"></a>Centos7下部署CDH6</h2><h3 id="1-安装之前"><a href="#1-安装之前" class="headerlink" title="1.安装之前"></a>1.安装之前</h3><p><a href="https://www.cloudera.com/documentation/enterprise/6/6.0/topics/installation.html" target="_blank" rel="noopener">官方安装步骤</a></p><p><strong>CDH6与CDH5的安装步骤一致，主要包括以下四部分：</strong></p><ul><li><p>1.安全前置准备，包括安装操作系统、关闭防火墙、同步服务器时钟等；</p></li><li><p>2.外部数据库如MySQL安装</p></li><li><p>3.安装Cloudera Manager；</p></li><li><p>4.安装CDH集群；</p></li></ul><p><strong>请务必注意CDH6的安装前置条件包括如下：</strong></p><ul><li><p>外部数据库支持：</p><ul><li><p>MySQL 5.7或更高</p></li><li><p>MariaDB 5.5或更高</p></li><li><p>PostgreSQL 8.4或更高</p></li><li><p>Oracle 12c或更高</p></li></ul></li><li><p>JDK</p><ul><li>Oracle JDK1.8，将不再支持JDK1.7</li></ul></li><li><p>操作系统支持</p><ul><li><p>RHEL 6.8或更高</p></li><li><p>RHEL 7.2或更高</p></li><li><p>SLES 12 SP2或更高</p></li><li><p>Ubuntu 16或更高</p></li></ul></li></ul><h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h3><table><thead><tr><th>ip</th><th>角色</th><th>备注</th></tr></thead><tbody><tr><td>10.240.9.132</td><td>CM Server，datanode</td><td></td></tr><tr><td>10.240.9.165</td><td>namenode，datanode</td><td></td></tr><tr><td>10.240.9.170</td><td>namenode，datanode</td><td></td></tr><tr><td>10.240.9.171</td><td>datanode</td><td></td></tr><tr><td>10.240.9.172</td><td>datanode</td></tr></tbody></table><h4 id="2-1-安装依赖"><a href="#2-1-安装依赖" class="headerlink" title="2.1.安装依赖"></a>2.1.安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装pip，安装psycopg2</span></span><br><span class="line">yum install -y mysql-devel python-devel &amp;&amp; \</span><br><span class="line">  curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py &amp;&amp; python get-pip.py &amp;&amp; \</span><br><span class="line">  pip install psycopg2==2.7.5 --ignore-installed</span><br><span class="line"><span class="comment"># 安装cyrus-sasl相关（Kerberos认证相关依赖）</span></span><br><span class="line">yum install -y cyrus-sasl-plain  cyrus-sasl-devel  cyrus-sasl-gssapi</span><br></pre></td></tr></table></figure><h4 id="2-2-搭建cm包yum源-10-240-9-132节点"><a href="#2-2-搭建cm包yum源-10-240-9-132节点" class="headerlink" title="2.2.搭建cm包yum源(10.240.9.132节点)"></a>2.2.搭建cm包yum源(10.240.9.132节点)</h4><ul><li><p>安装web服务器，nginx或者httpd</p><p><img src="images/cdh6-nginx01.png" alt></p></li></ul><ul><li><p>获取cm yum源包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir/data/cloudera_soft/CDH6.0.0/cm</span><br><span class="line"><span class="built_in">cd</span> /data/cloudera_soft/CDH6.0.0/cm</span><br><span class="line"><span class="comment"># 进入web服务器文件目录</span></span><br><span class="line">wget --recursive --no-parent --no-host-directories https://archive.cloudera.com/cm6/6.0.0/redhat7/</span><br><span class="line">chmod -R ugo+rX cm6</span><br><span class="line"><span class="built_in">cd</span> /data/cloudera_soft/CDH6.0.0/cm/cm6/6.0.0</span><br><span class="line">wget https://archive.cloudera.com/cm6/6.0.0/allkeys.asc</span><br></pre></td></tr></table></figure><p>浏览器访问<a href="http://10.240.9.132:8900/检查" target="_blank" rel="noopener">http://10.240.9.132:8900/检查</a></p></li></ul><p>  <img src="images/cdh6-nginx02.png" alt></p><p>  <img src="images/cdh6-nginx03.png" alt></p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置yum源</span></span><br><span class="line">vim /etc/yum.repos.d/cloudera-repo.repo</span><br><span class="line"></span><br><span class="line">[cloudera-repo]</span><br><span class="line">name=cloudera-repo</span><br><span class="line">baseurl=http://10.240.9.132:8900/CDH6.0.0/cm/cm6/6.0.0/redhat7/yum/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/yum.repos.d/cloudera-repo.repo 10.240.9.165:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/cloudera-repo.repo 10.240.9.170:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/cloudera-repo.repo 10.240.9.171:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/cloudera-repo.repo 10.240.9.172:/etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点</span></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h4 id="2-3-获取CDH6的parcels包-10-240-9-132节点"><a href="#2-3-获取CDH6的parcels包-10-240-9-132节点" class="headerlink" title="2.3.获取CDH6的parcels包(10.240.9.132节点)"></a>2.3.获取CDH6的parcels包(10.240.9.132节点)</h4><p><a href="https://archive.cloudera.com/cdh6/6.0.0/parcels/" target="_blank" rel="noopener">https://archive.cloudera.com/cdh6/6.0.0/parcels/</a></p><p><a href="https://archive.cloudera.com/cdh6/6.0.0/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel" target="_blank" rel="noopener">CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel</a></p><p><a href="https://archive.cloudera.com/cdh6/6.0.0/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel.sha256" target="_blank" rel="noopener">CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel.sha256</a></p><p><a href="https://archive.cloudera.com/cdh6/6.0.0/parcels/manifest.json" target="_blank" rel="noopener">manifest.json</a></p><p><strong>注意：</strong></p><ul><li>需要修改CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel.sha256文件名为CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel.sha</li><li>获取本地parcel包失败时可从manifest.json中获取sha值，修改CDH-6.0.0-1.cdh6.0.0.p0.537114-el7.parcel.sha的值</li></ul><h4 id="2-4-网络配置"><a href="#2-4-网络配置" class="headerlink" title="2.4.网络配置"></a>2.4.网络配置</h4><ul><li><p>修改主机名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别在对应机器上执行</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh01</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh02</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh03</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh04</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh05</span><br></pre></td></tr></table></figure></li><li><p>配置hosts文件 (所有节点)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">10.240.9.132 cdh01</span><br><span class="line">10.240.9.165 cdh02</span><br><span class="line">10.240.9.170 cdh03</span><br><span class="line">10.240.9.171 cdh04</span><br><span class="line">10.240.9.172 cdh05</span><br></pre></td></tr></table></figure></li><li><p>配置ssh免密登录</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在cdh01上执行</span></span><br><span class="line">ssh-keygen -t rsa -P <span class="string">''</span> -f ~/.ssh/id_rsa</span><br><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">chmod 0600 ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥认证</span></span><br><span class="line">ssh-copy-id -i cdh01</span><br><span class="line">ssh-copy-id -i cdh02</span><br><span class="line">ssh-copy-id -i cdh03</span><br><span class="line"><span class="comment"># 输入机器用户密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝密钥对到各个机器上去</span></span><br><span class="line">scp -r ~/.ssh/ cdh01:~/</span><br><span class="line">scp -r ~/.ssh/ cdh02:~/</span><br><span class="line">scp -r ~/.ssh/ cdh03:~/</span><br></pre></td></tr></table></figure><ul><li>关闭防火墙 （所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># 设置防火墙开机不自启 </span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><ul><li>关闭selinux（所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机不自启</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="comment"># 修改"SELINUX=enforcing"为"SELINUX=disabled"</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SELINUX 状态：</span></span><br><span class="line">/usr/sbin/sestatus –v</span><br><span class="line"><span class="comment"># SELinux status: enabled（enabled：开启；disabled：关闭）</span></span><br></pre></td></tr></table></figure><ul><li><strong>设置swap</strong>（所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> vm.swappiness = 10 &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl vm.swappiness=10</span><br></pre></td></tr></table></figure><ul><li><strong>设置透明大页面</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="comment"># 设置到开机启动</span></span><br><span class="line">vim /etc/rc.d/rc.local</span><br><span class="line"><span class="comment"># 添加如下脚本</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/enabled; <span class="keyword">then</span> <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled <span class="keyword">fi</span> <span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/defrag; <span class="keyword">then</span> <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h4 id="2-5-JDK安装（所有节点）"><a href="#2-5-JDK安装（所有节点）" class="headerlink" title="2.5.JDK安装（所有节点）"></a>2.5.JDK安装（所有节点）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install -y oracle-j2sdk1.8</span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># for jdk</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/jdk1.8.0_141-cloudera/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JAVA_HOME</span>/jre/lib:<span class="variable">$CLASSPATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生效配置</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查java</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><h4 id="2-6-配置ntp"><a href="#2-6-配置ntp" class="headerlink" title="2.6.配置ntp"></a>2.6.配置ntp</h4><p><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/install_cdh_enable_ntp.html" target="_blank" rel="noopener">官方文档</a></p><ul><li><p>安装ntp（所有节点）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntp</span><br></pre></td></tr></table></figure></li><li><p>配置</p><ul><li><p>cdh01节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01主节点配置</span></span><br><span class="line">vi /etc/ntp.conf</span><br><span class="line"><span class="comment"># 注释默认的server,添加以下server</span></span><br><span class="line">server 210.72.145.44 perfer   <span class="comment"># 中国国家受时中心</span></span><br><span class="line">server 202.112.10.36             <span class="comment"># 1.cn.pool.ntp.org</span></span><br><span class="line">server 59.124.196.83             <span class="comment"># 0.asia.pool.ntp.org</span></span><br><span class="line">server  127.127.1.0     <span class="comment"># local clock</span></span><br><span class="line">fudge   127.127.1.0 stratum 10</span><br></pre></td></tr></table></figure></li><li><p>cdh02、cdh03节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ntp.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 子节点把所有server行注释掉，添加下面一行</span></span><br><span class="line">server cdh01</span><br></pre></td></tr></table></figure></li><li><p>所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ntpd</span><br><span class="line">systemctl <span class="built_in">enable</span> ntpd</span><br><span class="line">ntpstat</span><br></pre></td></tr></table></figure><blockquote><p>synchronised to NTP server (10.240.9.132) at stratum 12<br>   time correct to within 896 ms<br>   polling server every 64 s</p></blockquote></li></ul></li></ul><p><img src="D:/%E5%B7%A5%E4%BD%9C/%E9%A1%B9%E7%9B%AE%E8%B5%84%E6%96%99/CDH/%E6%96%87%E6%A1%A3/CDH%E7%AC%94%E8%AE%B0/images/cdh6-ntp01.png" alt></p><h4 id="2-7-cdh01节点安装配置MySQL"><a href="#2-7-cdh01节点安装配置MySQL" class="headerlink" title="2.7.cdh01节点安装配置MySQL"></a>2.7.cdh01节点安装配置MySQL</h4><ul><li>安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum update</span><br><span class="line">yum install mysql-server</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br><span class="line">cp /etc/my.cnf /etc/my.cnf.default</span><br><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除原有配置，并修改为如下建议配置</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">transaction-isolation = READ-COMMITTED</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks;</span></span><br><span class="line"><span class="comment"># to do so, uncomment this line:</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line"></span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">thread_stack = 256K</span><br><span class="line">thread_cache_size = 64</span><br><span class="line">query_cache_limit = 8M</span><br><span class="line">query_cache_size = 64M</span><br><span class="line">query_cache_type = 1</span><br><span class="line"></span><br><span class="line">max_connections = 550</span><br><span class="line"><span class="comment">#expire_logs_days = 10</span></span><br><span class="line"><span class="comment">#max_binlog_size = 100M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#log_bin should be on a disk with enough free space.</span></span><br><span class="line"><span class="comment">#Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your</span></span><br><span class="line"><span class="comment">#system and chown the specified folder to the mysql user.</span></span><br><span class="line">log_bin=/var/lib/mysql/mysql_binary_log</span><br><span class="line"></span><br><span class="line"><span class="comment">#In later versions of MySQL, if you enable the binary log and do not set</span></span><br><span class="line"><span class="comment">#a server_id, MySQL will not start. The server_id must be unique within</span></span><br><span class="line"><span class="comment">#the replicating group.</span></span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line">binlog_format = mixed</span><br><span class="line"></span><br><span class="line">read_buffer_size = 2M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">sort_buffer_size = 8M</span><br><span class="line">join_buffer_size = 8M</span><br><span class="line"></span><br><span class="line"><span class="comment"># InnoDB settings</span></span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_flush_log_at_trx_commit  = 2</span><br><span class="line">innodb_log_buffer_size = 64M</span><br><span class="line">innodb_buffer_pool_size = 4G</span><br><span class="line">innodb_thread_concurrency = 8</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_log_file_size = 512M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">sql_mode=STRICT_ALL_TABLES</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>设置root密码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/mysql_secure_installation</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line">[...]</span><br><span class="line">Set root password? [Y/n] Y</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">Remove anonymous users? [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Disallow root login remotely? [Y/n] N</span><br><span class="line">[...]</span><br><span class="line">Remove <span class="built_in">test</span> database and access to it [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Reload privilege tables now? [Y/n] Y</span><br><span class="line">All <span class="keyword">done</span>!</span><br></pre></td></tr></table></figure><ul><li>安装配置MySQL JDBC 驱动</li></ul><p>下载 .tar.gz格式的文件地址：<a href="http://www.mysql.com/downloads/connector/j/5.1.html" target="_blank" rel="noopener">http://www.mysql.com/downloads/connector/j/5.1.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/share/java/</span><br><span class="line"></span><br><span class="line">cp mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar \</span><br><span class="line"> /usr/share/java/mysql-connector-java.jar</span><br><span class="line"> </span><br><span class="line">scp -r /usr/share/java/ cdh02:/usr/share/</span><br><span class="line">scp -r /usr/share/java/ cdh03:/usr/share/</span><br></pre></td></tr></table></figure><ul><li>创建对应服务数据库</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE metastore DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON metastore.* TO &apos;hive&apos;@&apos;%&apos; IDENTIFIED BY &apos;hive&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE hue DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON hue.* TO &apos;hue&apos;@&apos;%&apos; IDENTIFIED BY &apos;hue&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE sentry DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON sentry.* TO &apos;sentry&apos;@&apos;%&apos; IDENTIFIED BY &apos;sentry&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE oozie DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON oozie.* TO &apos;oozie&apos;@&apos;%&apos; IDENTIFIED BY &apos;oozie&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE am DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON am.* TO &apos;am&apos;@&apos;%&apos; IDENTIFIED BY &apos;am&apos;;</span><br></pre></td></tr></table></figure><h3 id="3-CM安装"><a href="#3-CM安装" class="headerlink" title="3.CM安装"></a>3.CM安装</h3><h4 id="3-1-安装CM-Server服务-10-240-9-132"><a href="#3-1-安装CM-Server服务-10-240-9-132" class="headerlink" title="3.1.安装CM Server服务(10.240.9.132)"></a>3.1.安装CM Server服务(10.240.9.132)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cloudera-manager-daemons cloudera-manager-agent cloudera-manager-server</span><br></pre></td></tr></table></figure><h4 id="3-2-配置CDH本地parcel-repo"><a href="#3-2-配置CDH本地parcel-repo" class="headerlink" title="3.2.配置CDH本地parcel-repo"></a>3.2.配置CDH本地parcel-repo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">cp ~/CDH-6.0.0-1.cdh6.0.0.p0.537114-el7* /opt/cloudera/parcel-repo</span><br><span class="line">cp ~/manifest.json /opt/cloudera/parcel-repo</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cloudera/</span><br></pre></td></tr></table></figure><h4 id="3-3-cdh01节点初始化数据库"><a href="#3-3-cdh01节点初始化数据库" class="headerlink" title="3.3.cdh01节点初始化数据库"></a>3.3.cdh01节点初始化数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">/opt/cloudera/cm/schema/scm_prepare_database.sh mysql -hlocalhost -uroot -p123456 --scm-host localhost scm scm scm</span><br></pre></td></tr></table></figure><h4 id="3-4-启动服务"><a href="#3-4-启动服务" class="headerlink" title="3.4.启动服务"></a>3.4.启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl start cloudera-scm-server</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-server/cloudera-scm-server.log</span><br><span class="line"><span class="comment"># 日志内容包含如下信息CM启动成功</span></span><br><span class="line">INFO WebServerImpl:com.cloudera.server.cmf.WebServerImpl: Started Jetty server.</span><br></pre></td></tr></table></figure><h3 id="4-安装CDH服务"><a href="#4-安装CDH服务" class="headerlink" title="4.安装CDH服务"></a>4.安装CDH服务</h3><ul><li>访问CM web界面</li></ul><p><a href="http://10.240.9.132:7180" target="_blank" rel="noopener">http://10.240.9.132:7180</a></p><p>用户：admin</p><p>密码：admin</p><ul><li>安装步骤</li></ul><p><img src="images/cdh6/cdh6-01.png" alt></p><p><img src="images/cdh6/cdh6-02.png" alt></p><p><img src="images/cdh6/cdh6-03.png" alt></p><p><img src="images/cdh6/cdh6-04.png" alt></p><p><img src="images/cdh6/cdh6-05.png" alt></p><p><img src="images/cdh6/cdh6-06.png" alt></p><p><img src="images/cdh6/cdh6-07.png" alt></p><p><img src="images/cdh6/cdh6-08.png" alt></p><p><img src="images/cdh6/cdh6-09.png" alt></p><p><img src="images/cdh6/cdh6-10.png" alt></p><p><img src="images/cdh6/cdh6-11.png" alt></p><p><img src="images/cdh6/cdh6-12.png" alt></p><p><img src="images/cdh6/cdh6-13.png" alt></p><p><img src="images/cdh6/cdh6-14.png" alt></p><p><strong>设置swap</strong>（所有节点）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> vm.swappiness = 10 &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl vm.swappiness=10</span><br></pre></td></tr></table></figure><p><strong>设置透明大页面</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="comment"># 设置到开机启动</span></span><br><span class="line">vim /etc/rc.d/rc.local</span><br><span class="line"><span class="comment"># 添加如下脚本</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/enabled; <span class="keyword">then</span> <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled <span class="keyword">fi</span> <span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/defrag; <span class="keyword">then</span> <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装pip，安装psycopg2</span></span><br><span class="line">yum install -y mysql-devel python-devel &amp;&amp; \</span><br><span class="line">  curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py &amp;&amp; python get-pip.py &amp;&amp; \</span><br><span class="line">  pip install psycopg2==2.7.5 --ignore-installed</span><br></pre></td></tr></table></figure><p><img src="images/cdh6/cdh6-15.png" alt></p><p><img src="images/cdh6/cdh6-16.png" alt></p><ul><li>配置角色</li></ul><p><img src="images/cdh6/cdh6-17.png" alt></p><p><img src="images/cdh6/cdh6-18.png" alt></p><p><img src="images/cdh6/cdh6-19.png" alt></p><p><img src="images/cdh6/cdh6-20.png" alt></p><p><img src="images/cdh6/cdh6-21.png" alt></p><p><img src="images/cdh6/cdh6-22.png" alt></p><p><img src="images/cdh6/cdh6-23.png" alt></p><p><img src="images/cdh6/cdh6-24.png" alt></p><p><img src="images/cdh6/cdh6-25.png" alt></p><p><img src="images/cdh6/cdh6-26.png" alt></p><p><img src="images/cdh6/cdh6-27.png" alt></p><p><img src="images/cdh6/cdh6-28.png" alt></p><p><img src="images/cdh6/cdh6-29.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Centos7下部署CDH6&quot;&gt;&lt;a href=&quot;#Centos7下部署CDH6&quot; class=&quot;headerlink&quot; title=&quot;Centos7下部署CDH6&quot;&gt;&lt;/a&gt;Centos7下部署CDH6&lt;/h2&gt;&lt;h3 id=&quot;1-安装之前&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/Centos7%E5%9C%A8%E7%BA%BF%E9%83%A8%E7%BD%B2CDH5/"/>
    <id>http://yoursite.com/2019/02/16/Centos7在线部署CDH5/</id>
    <published>2019-02-16T15:32:13.122Z</published>
    <updated>2019-02-16T15:32:13.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Centos7在线部署CDH5"><a href="#Centos7在线部署CDH5" class="headerlink" title="Centos7在线部署CDH5"></a>Centos7在线部署CDH5</h2><p>[TOC]</p><h3 id="1-安装之前"><a href="#1-安装之前" class="headerlink" title="1.安装之前"></a>1.安装之前</h3><ul><li><p><a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html" target="_blank" rel="noopener">CDH 5 和 CM 5 的依赖和支持的版本</a></p></li><li><p><a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/hardware_requirements_guide.html" target="_blank" rel="noopener">硬件要求指南</a></p><p><a href="http://blog.cloudera.com/blog/2013/08/how-to-select-the-right-hardware-for-your-new-hadoop-cluster/" target="_blank" rel="noopener">How-to: Select the Right Hardware for Your New Hadoop Cluster</a></p></li><li><p><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/installation_reqts.html" target="_blank" rel="noopener">Before You Install</a></p></li></ul><p><strong>安装之前建议阅读如上官方安装指南</strong></p><p><a href="https://cloud.tencent.com/developer/article/1158361" target="_blank" rel="noopener">如何在Redhat7.4安装CDH5.15</a></p><h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h3><ul><li><p>3台16核32G内存260G硬盘CentOS 7机器</p><p>机器规划：</p></li></ul><table><thead><tr><th>HostName</th><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>cdh001</td><td>CM节点，NameNode，Active Monitor,DataNode</td><td>192.168.31.151</td></tr><tr><td>cdh002</td><td>DataNode、 JobTracker</td><td>192.168.31.152</td></tr><tr><td>cdh003</td><td>DataNode、 JobTracker</td><td>192.168.31.153</td></tr></tbody></table><ul><li><p>CM离线包</p><p><a href="http://archive-primary.cloudera.com/cm5/cm/5/" target="_blank" rel="noopener">CM下载地址</a></p><ul><li><a href="http://archive-primary.cloudera.com/cm5/cm/5/cloudera-manager-centos7-cm5.15.1_x86_64.tar.gz" target="_blank" rel="noopener">cloudera-manager-centos7-cm5.15.1_x86_64.tar.gz</a> </li></ul></li><li><p>CDH离线包</p><p><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/" target="_blank" rel="noopener">CDH下载地址</a></p><ul><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel" target="_blank" rel="noopener">CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel</a></li><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha1" target="_blank" rel="noopener">CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha1</a> <strong>(注意下载后需要重命名为**.sha,否则安装parcel的时候会在线下载)</strong></li><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/manifest.json" target="_blank" rel="noopener">manifest.json</a> </li></ul></li><li><p>JDK1.8u162</p><ul><li><a href="https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html" target="_blank" rel="noopener">下载地址</a></li></ul></li><li><p>JDBC</p><ul><li><a href="http://www.mysql.com/downloads/connector/j/5.1.html" target="_blank" rel="noopener">下载地址</a></li></ul></li><li><p>操作系统依赖</p><ul><li><p>psmisc    </p><p><em>CM客户端和服务端启动脚本会使用pstree命令，不安装会报找不到命令</em></p></li><li><p>libxslt-devel libxml2-devel</p><p><em>不安装的话Hue安装时测试MySQL会报错</em></p></li><li><p>krb5-devel cyrus-sasl-gssapi cyrus-sasl-deve</p><p>Kerberos相关依赖</p></li><li><p>openldap-devel python-devel</p><p>相关开发依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点安装</span></span><br><span class="line">yum install -y psmisc libxslt-devel libxml2-devel krb5-devel cyrus-sasl-gssapi cyrus-sasl-deve openldap-devel python-devel wget</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-CM安装"><a href="#3-CM安装" class="headerlink" title="3.CM安装"></a>3.CM安装</h3><p><strong>本次安装使用搭建内网仓库镜像安装：</strong></p><p><code>使用官方镜像仓库安装CM步骤参阅：</code><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/install_cm_cdh.html" target="_blank" rel="noopener">官方在线安装指南</a></p><h4 id="3-1-网络配置"><a href="#3-1-网络配置" class="headerlink" title="3.1.网络配置"></a>3.1.网络配置</h4><ul><li><p>修改主机名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别在对应机器上执行</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh01</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh02</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh03</span><br></pre></td></tr></table></figure></li></ul><p><img src="images/hostname01.png" alt="设置hostname"></p><ul><li><p>配置hosts文件 (所有节点)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.31.151 cdh01</span><br><span class="line">192.168.31.152 cdh02</span><br><span class="line">192.168.31.153 cdh03</span><br></pre></td></tr></table></figure><p><img src="images/hostname02.png" alt="设置hosts"></p></li></ul><ul><li>配置ssh免密登录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在cdh01上执行</span></span><br><span class="line">ssh-keygen</span><br><span class="line"><span class="comment"># 一路回车默认在~/.ssh目录下生成RSA密钥对id_rsa(私钥)，id_rsa.pub（公钥）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥认证</span></span><br><span class="line">ssh-copy-id -i cdh01</span><br><span class="line">ssh-copy-id -i cdh02</span><br><span class="line">ssh-copy-id -i cdh03</span><br><span class="line"><span class="comment"># 输入机器用户密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝密钥对到各个机器上去</span></span><br><span class="line">scp -r ~/.ssh/ cdh01:~/</span><br><span class="line">scp -r ~/.ssh/ cdh02:~/</span><br><span class="line">scp -r ~/.ssh/ cdh03:~/</span><br></pre></td></tr></table></figure><ul><li>关闭防火墙 （所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># 设置防火墙开机不自启 </span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><ul><li>关闭selinux（所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机不自启</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="comment"># 修改"SELINUX=enforcing"为"SELINUX=disabled"</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SELINUX 状态：</span></span><br><span class="line">/usr/sbin/sestatus –v</span><br><span class="line"><span class="comment"># SELinux status: enabled（enabled：开启；disabled：关闭）</span></span><br></pre></td></tr></table></figure><p><img src="images/selinux.png" alt></p><h4 id="3-2-JDK安装"><a href="#3-2-JDK安装" class="headerlink" title="3.2.JDK安装"></a>3.2.JDK安装</h4><ul><li><p>官方JDK安装要求</p><ul><li>The JDK <strong>must be 64-bit</strong>. Do not use a 32-bit JDK.</li><li>The installed JDK must be a supported version as documented in <a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/rn_consolidated_pcm.html#pcm_jdk" target="_blank" rel="noopener">CDH and Cloudera Manager Supported JDK Versions</a>.<ul><li><a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html" target="_blank" rel="noopener">Oracle JDK 7</a> is supported across all versions of Cloudera Manager 5 and CDH 5.</li><li><a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html" target="_blank" rel="noopener">Oracle JDK 8</a> is supported in C5.3.x and higher.</li><li>Oracle JDK 9 is not supported in any Cloudera Manager or CDH version.</li></ul></li><li>The <em>same version</em> of the Oracle JDK must be installed on each cluster host.</li><li>The JDK must be installed at <strong>/usr/java/jdk-version</strong>.</li></ul><blockquote><p><strong>Important</strong>:The RHEL-compatible and Ubuntu operating systems supported by Cloudera Enterprise all use AES-256 encryption by default for tickets. To support AES-256 bit encryption in JDK versions lower than <strong>1.8u161</strong>, you must install the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy File</a> on all cluster and Hadoop user machines. Cloudera Manager can automatically install the policy files, or you can install them manually. For JCE Policy File installation instructions, see the README.txtfile included in the jce_policy-x.zip file. JDK 1.8u161 and higher enable unlimited strength encryption by default, and do not require policy files.On SLES platforms, do not install or try to use the IBM Java version bundled with the SLES distribution. CDH does not run correctly with that version.  </p></blockquote><p><strong>根据<a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html#concept_ihg_vf4_j1b" target="_blank" rel="noopener">官方指南</a>因此本次安装选择JDK充分测试过且支持的最高版本JDK1.8u162</strong></p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传下载的jdk到cdh01机器上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动到/opt/java目录下</span></span><br><span class="line">mkdir /usr/java/</span><br><span class="line">tar zxvf jdk-8u162-linux-x64.tar.gz -C /usr/java/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="comment"># 在最末尾加上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for jdk</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/jdk1.8.0_162</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生效环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment"># 检查是否生效</span></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将jdk拷贝到其他节点上去</span></span><br><span class="line">scp -r /usr/java/ cdh02:/usr/</span><br><span class="line">scp -r /usr/java/ cdh03:/usr/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝环境变量到其他节点上去</span></span><br><span class="line">scp /etc/profile cdh02:/etc/</span><br><span class="line">scp /etc/profile cdh03:/etc/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在其他节点检查jdk环境是否生效</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p><img src="images/jdk_version.png" alt="jdk版本"></p><h4 id="3-3-配置ntp"><a href="#3-3-配置ntp" class="headerlink" title="3.3.配置ntp"></a>3.3.配置ntp</h4><p><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/install_cdh_enable_ntp.html" target="_blank" rel="noopener">官方文档</a></p><ul><li><p>安装ntp（所有节点）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntp</span><br></pre></td></tr></table></figure></li><li><p>配置</p><ul><li><p>cdh01节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01主节点配置</span></span><br><span class="line">vi /etc/ntp.conf</span><br><span class="line"><span class="comment"># 注释默认的server,添加以下server</span></span><br><span class="line">server 210.72.145.44 perfer   <span class="comment"># 中国国家受时中心</span></span><br><span class="line">server 202.112.10.36             <span class="comment"># 1.cn.pool.ntp.org</span></span><br><span class="line">server 59.124.196.83             <span class="comment"># 0.asia.pool.ntp.org</span></span><br><span class="line">server  127.127.1.0     <span class="comment"># local clock</span></span><br><span class="line">fudge   127.127.1.0 stratum 10</span><br></pre></td></tr></table></figure></li><li><p>cdh02、cdh03节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ntp.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 子节点把所有server行注释掉，添加下面一行</span></span><br><span class="line">server cdh01</span><br></pre></td></tr></table></figure></li><li><p>所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ntpd</span><br><span class="line">systemctl <span class="built_in">enable</span> ntpd</span><br><span class="line">ntpstat</span><br></pre></td></tr></table></figure><blockquote><p>synchronised to NTP server (192.168.31.151) at stratum 12<br>   time correct to within 909 ms<br>   polling server every 64 s</p></blockquote></li></ul></li></ul><h4 id="3-4-cdh01节点安装配置MySQL"><a href="#3-4-cdh01节点安装配置MySQL" class="headerlink" title="3.4.cdh01节点安装配置MySQL"></a>3.4.cdh01节点安装配置MySQL</h4><ul><li>安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum update</span><br><span class="line">yum install mysql-server</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br><span class="line">cp /etc/my.cnf /etc/my.cnf.default</span><br><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除原有配置，并修改为如下建议配置</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">transaction-isolation = READ-COMMITTED</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks;</span></span><br><span class="line"><span class="comment"># to do so, uncomment this line:</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line"></span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">thread_stack = 256K</span><br><span class="line">thread_cache_size = 64</span><br><span class="line">query_cache_limit = 8M</span><br><span class="line">query_cache_size = 64M</span><br><span class="line">query_cache_type = 1</span><br><span class="line"></span><br><span class="line">max_connections = 550</span><br><span class="line"><span class="comment">#expire_logs_days = 10</span></span><br><span class="line"><span class="comment">#max_binlog_size = 100M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#log_bin should be on a disk with enough free space.</span></span><br><span class="line"><span class="comment">#Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your</span></span><br><span class="line"><span class="comment">#system and chown the specified folder to the mysql user.</span></span><br><span class="line">log_bin=/var/lib/mysql/mysql_binary_log</span><br><span class="line"></span><br><span class="line"><span class="comment">#In later versions of MySQL, if you enable the binary log and do not set</span></span><br><span class="line"><span class="comment">#a server_id, MySQL will not start. The server_id must be unique within</span></span><br><span class="line"><span class="comment">#the replicating group.</span></span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line">binlog_format = mixed</span><br><span class="line"></span><br><span class="line">read_buffer_size = 2M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">sort_buffer_size = 8M</span><br><span class="line">join_buffer_size = 8M</span><br><span class="line"></span><br><span class="line"><span class="comment"># InnoDB settings</span></span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_flush_log_at_trx_commit  = 2</span><br><span class="line">innodb_log_buffer_size = 64M</span><br><span class="line">innodb_buffer_pool_size = 4G</span><br><span class="line">innodb_thread_concurrency = 8</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_log_file_size = 512M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">sql_mode=STRICT_ALL_TABLES</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>设置root密码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/mysql_secure_installation</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line">[...]</span><br><span class="line">Set root password? [Y/n] Y</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">Remove anonymous users? [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Disallow root login remotely? [Y/n] N</span><br><span class="line">[...]</span><br><span class="line">Remove <span class="built_in">test</span> database and access to it [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Reload privilege tables now? [Y/n] Y</span><br><span class="line">All <span class="keyword">done</span>!</span><br></pre></td></tr></table></figure><ul><li>安装配置MySQL JDBC 驱动</li></ul><p>下载 .tar.gz格式的文件地址：<a href="http://www.mysql.com/downloads/connector/j/5.1.html" target="_blank" rel="noopener">http://www.mysql.com/downloads/connector/j/5.1.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/share/java/</span><br><span class="line"></span><br><span class="line">cp mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar \</span><br><span class="line"> /usr/share/java/mysql-connector-java.jar</span><br><span class="line"> </span><br><span class="line">scp -r /usr/share/java/ cdh02:/usr/share/</span><br><span class="line">scp -r /usr/share/java/ cdh03:/usr/share/</span><br></pre></td></tr></table></figure><ul><li>创建对应服务数据库</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> hue <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> hue.* <span class="keyword">TO</span> <span class="string">'hue'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'hue'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> metastore <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> metastore.* <span class="keyword">TO</span> <span class="string">'hive'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'hive'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> sentry <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> sentry.* <span class="keyword">TO</span> <span class="string">'sentry'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'sentry'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> oozie <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> oozie.* <span class="keyword">TO</span> <span class="string">'oozie'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'oozie'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> am <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> am.* <span class="keyword">TO</span> <span class="string">'am'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'am'</span>;</span><br></pre></td></tr></table></figure><h4 id="3-5-配置镜像仓库-cdh01节点"><a href="#3-5-配置镜像仓库-cdh01节点" class="headerlink" title="3.5. 配置镜像仓库(cdh01节点)"></a>3.5. 配置镜像仓库(cdh01节点)</h4><ul><li><p>搭建web文件服务器（长期使用：nginx、apache）（临时使用：Python web服务器）</p></li><li><p>下载镜像对应安装版本文件包（国内网络最好使用代理）</p><ul><li><strong>Cloudera Manager 5:</strong> <a href="https://archive.cloudera.com/cm5/repo-as-tarball/" target="_blank" rel="noopener">https://archive.cloudera.com/cm5/repo-as-tarball/</a></li><li><strong>CDH 5:</strong> <a href="https://archive.cloudera.com/cdh5/repo-as-tarball/" target="_blank" rel="noopener">https://archive.cloudera.com/cdh5/repo-as-tarball/</a></li></ul><p><strong>本次安装下载：</strong></p><p><a href="https://archive.cloudera.com/cm5/repo-as-tarball/5.15.1/cm5.15.1-centos7.tar.gz" target="_blank" rel="noopener">cm5.15.1-centos7.tar.gz</a>  和 <a href="https://archive.cloudera.com/cdh5/repo-as-tarball/5.15.1/cdh5.15.1-centos7.tar.gz" target="_blank" rel="noopener">cdh5.15.1-centos7.tar.gz</a> </p></li><li><p>解压下载文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf cm5.15.1-centos7.tar.gz</span><br><span class="line">tar zxvf cdh5.15.1-centos7.tar.gz</span><br></pre></td></tr></table></figure><ul><li>长期仓库：nginx或者apache服务器</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv cm /var/www/html</span><br><span class="line">chmod -R ugo+rX /var/www/html/cm</span><br><span class="line">mv cdh /var/www/html</span><br><span class="line">chmod -R ugo+rX /var/www/html/cdh</span><br></pre></td></tr></table></figure><ul><li>临时使用</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 8900</span><br><span class="line"></span><br><span class="line">Serving HTTP on 0.0.0.0 port 8900 ...</span><br></pre></td></tr></table></figure></li><li><p>配置YUM源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/yum.repos.d/cloudera-repo.repo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[cloudera-repo]</span><br><span class="line">name=cloudera-repo</span><br><span class="line">baseurl=http://192.168.31.151:8900/cm/5</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-6-安装CM-Server服务"><a href="#3-6-安装CM-Server服务" class="headerlink" title="3.6.安装CM Server服务"></a>3.6.安装CM Server服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cloudera-manager-daemons cloudera-manager-server</span><br></pre></td></tr></table></figure><h4 id="3-7-配置CDH本地parcel-repo"><a href="#3-7-配置CDH本地parcel-repo" class="headerlink" title="3.7.配置CDH本地parcel-repo"></a>3.7.配置CDH本地parcel-repo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">mkdir -p /opt/cloudera/parcel-repo</span><br><span class="line">mv CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel manifest.json /opt/cloudera/parcel-repo/</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cloudera/</span><br><span class="line">mkdir /var/lib/cloudera-scm-server</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># cdh02、cdh03节点</span></span><br><span class="line">mkdir -p /opt/cloudera/parcel-repo</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cloudera/</span><br></pre></td></tr></table></figure><h4 id="3-8-cdh01节点初始化数据库"><a href="#3-8-cdh01节点初始化数据库" class="headerlink" title="3.8.cdh01节点初始化数据库"></a>3.8.cdh01节点初始化数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">/usr/share/cmf/schema/scm_prepare_database.sh mysql -hlocalhost -uroot -p123456 --scm-host localhost scm scm scm</span><br></pre></td></tr></table></figure><h4 id="3-9-启动服务"><a href="#3-9-启动服务" class="headerlink" title="3.9.启动服务"></a>3.9.启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl start cloudera-scm-server</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-server/cloudera-scm-server.log</span><br><span class="line"><span class="comment"># 日志内容包含如下信息CM启动成功</span></span><br><span class="line">INFO WebServerImpl:com.cloudera.server.cmf.WebServerImpl: Started Jetty server.</span><br></pre></td></tr></table></figure><h4 id="3-11-初始化CM"><a href="#3-11-初始化CM" class="headerlink" title="3.11.初始化CM"></a>3.11.初始化CM</h4><ul><li><p>访问CM web界面</p><p><a href="http://192.168.31.151:7180/" target="_blank" rel="noopener">http://192.168.31.151:7180/</a></p><p>用户：admin</p><p>密码：admin</p></li><li><p>配置CM</p><p><img src="images/cm01.png" alt></p><p><img src="images/cm02.png" alt></p><p><img src="images/cm03.png" alt></p><p><img src="images/cm04.png" alt></p></li></ul><p><img src="images/cm05.png" alt>    </p><p><img src="images/cm06.png" alt></p><p><strong>此处会报两个错误：内存交换空间设置和启用了透明大页面压缩，点击【查看详细信息】查看需要修改设置的主机</strong> </p><ul><li><p>将机器设置成cloudera官方建议的配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sysctl vm.swappiness=10</span><br><span class="line"></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/sysctl.conf加入或修改vm.swappiness配置</span></span><br><span class="line">vm.swappiness=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag'</span> &gt;&gt; /etc/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.local</span><br><span class="line">cat /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br></pre></td></tr></table></figure><p><strong>修改完成重新运行检查主机检查，此时警告消除点击【完成】。</strong></p></li></ul><h3 id="4-安装CDH服务"><a href="#4-安装CDH服务" class="headerlink" title="4.安装CDH服务"></a>4.安装CDH服务</h3><ul><li>选择服务</li></ul><p><img src="images/cdh01.png" alt></p><ul><li>配置角色</li></ul><p><img src="images/cdh02.png" alt></p><ul><li>设置数据库连接</li></ul><p><img src="images/cdh03.png" alt></p><ul><li>集群设置</li></ul><p><img src="images/cdh04.png" alt></p><ul><li>开始安装</li></ul><p><img src="images/cdh05.png" alt></p><ul><li>完成安装</li></ul><p><img src="images/cdh06.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Centos7在线部署CDH5&quot;&gt;&lt;a href=&quot;#Centos7在线部署CDH5&quot; class=&quot;headerlink&quot; title=&quot;Centos7在线部署CDH5&quot;&gt;&lt;/a&gt;Centos7在线部署CDH5&lt;/h2&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h3 id=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/Centos7%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2%20CDH5/"/>
    <id>http://yoursite.com/2019/02/16/Centos7离线部署 CDH5/</id>
    <published>2019-02-16T15:32:13.122Z</published>
    <updated>2019-02-16T15:32:13.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Centos7离线部署-CDH5"><a href="#Centos7离线部署-CDH5" class="headerlink" title="Centos7离线部署 CDH5"></a>Centos7离线部署 CDH5</h2><p>[TOC]</p><h3 id="1-安装之前"><a href="#1-安装之前" class="headerlink" title="1.安装之前"></a>1.安装之前</h3><ul><li><p><a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html" target="_blank" rel="noopener">CDH 5 和 CM 5 的依赖和支持的版本</a></p></li><li><p><a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/hardware_requirements_guide.html" target="_blank" rel="noopener">硬件要求指南</a></p><p><a href="http://blog.cloudera.com/blog/2013/08/how-to-select-the-right-hardware-for-your-new-hadoop-cluster/" target="_blank" rel="noopener">How-to: Select the Right Hardware for Your New Hadoop Cluster</a></p></li><li><p><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/installation_reqts.html" target="_blank" rel="noopener">Before You Install</a></p></li></ul><p><strong>安装之前建议阅读如上官方安装指南</strong></p><h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h3><ul><li><p>3台16核32G内存260G硬盘CentOS 7机器</p><p>机器规划：</p></li></ul><table><thead><tr><th>HostName</th><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>cdh001</td><td>CM节点，NameNode，Active Monitor,DataNode</td><td>192.168.31.151</td></tr><tr><td>cdh002</td><td>DataNode、 JobTracker</td><td>192.168.31.152</td></tr><tr><td>cdh003</td><td>DataNode、 JobTracker</td><td>192.168.31.153</td></tr></tbody></table><ul><li><p>CDH离线包</p><p><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/" target="_blank" rel="noopener">CDH下载地址</a></p><ul><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel" target="_blank" rel="noopener">CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel</a></li><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha1" target="_blank" rel="noopener">CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha1</a> <strong>(注意下载后需要重命名为**.sha,否则安装parcel的时候会在线下载)</strong></li><li><a href="http://archive.cloudera.com/cdh5/parcels/5.15.1.4/manifest.json" target="_blank" rel="noopener">manifest.json</a> </li></ul></li><li><p>JDK1.8u162</p><ul><li><a href="https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html" target="_blank" rel="noopener">下载地址</a></li></ul></li><li><p>JDBC</p><ul><li><a href="http://www.mysql.com/downloads/connector/j/5.1.html" target="_blank" rel="noopener">下载地址</a></li></ul></li><li><p>操作系统依赖</p><ul><li><p>psmisc    </p><p><em>CM客户端和服务端启动脚本会使用pstree命令，不安装会报找不到命令</em></p></li><li><p>libxslt-devel libxml2-devel</p><p><em>不安装的话Hue安装时测试MySQL会报错</em></p></li><li><p>krb5-devel cyrus-sasl-gssapi cyrus-sasl-deve</p><p>Kerberos相关依赖</p></li><li><p>openldap-devel python-devel</p><p>相关开发依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点安装</span></span><br><span class="line">yum install -y psmisc libxslt-devel libxml2-devel krb5-devel cyrus-sasl-gssapi cyrus-sasl-deve openldap-devel python-devel wget</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-CM安装"><a href="#3-CM安装" class="headerlink" title="3.CM安装"></a>3.CM安装</h3><h4 id="3-1-网络配置"><a href="#3-1-网络配置" class="headerlink" title="3.1.网络配置"></a>3.1.网络配置</h4><ul><li><p>修改主机名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别在对应机器上执行</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh01</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh02</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname cdh03</span><br></pre></td></tr></table></figure></li></ul><p><img src="images/hostname01.png" alt="设置hostname"></p><ul><li><p>配置hosts文件 (所有节点)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.31.151 cdh01</span><br><span class="line">192.168.31.152 cdh02</span><br><span class="line">192.168.31.153 cdh03</span><br></pre></td></tr></table></figure><p><img src="images/hostname02.png" alt="设置hosts"></p></li></ul><ul><li>配置ssh免密登录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在cdh01上执行</span></span><br><span class="line">ssh-keygen</span><br><span class="line"><span class="comment"># 一路回车默认在~/.ssh目录下生成RSA密钥对id_rsa(私钥)，id_rsa.pub（公钥）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥认证</span></span><br><span class="line">ssh-copy-id -i cdh01</span><br><span class="line">ssh-copy-id -i cdh02</span><br><span class="line">ssh-copy-id -i cdh03</span><br><span class="line"><span class="comment"># 输入机器用户密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝密钥对到各个机器上去</span></span><br><span class="line">scp -r ~/.ssh/ cdh01:~/</span><br><span class="line">scp -r ~/.ssh/ cdh02:~/</span><br><span class="line">scp -r ~/.ssh/ cdh03:~/</span><br></pre></td></tr></table></figure><ul><li>关闭防火墙 （所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># 设置防火墙开机不自启 </span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><ul><li>关闭selinux（所有节点）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机不自启</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="comment"># 修改"SELINUX=enforcing"为"SELINUX=disabled"</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 SELINUX 状态：</span></span><br><span class="line">/usr/sbin/sestatus –v</span><br><span class="line"><span class="comment"># SELinux status: enabled（enabled：开启；disabled：关闭）</span></span><br></pre></td></tr></table></figure><p><img src="images/selinux.png" alt></p><h4 id="3-2-JDK安装"><a href="#3-2-JDK安装" class="headerlink" title="3.2.JDK安装"></a>3.2.JDK安装</h4><ul><li><p>官方JDK安装要求</p><ul><li>The JDK <strong>must be 64-bit</strong>. Do not use a 32-bit JDK.</li><li>The installed JDK must be a supported version as documented in <a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/rn_consolidated_pcm.html#pcm_jdk" target="_blank" rel="noopener">CDH and Cloudera Manager Supported JDK Versions</a>.<ul><li><a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html" target="_blank" rel="noopener">Oracle JDK 7</a> is supported across all versions of Cloudera Manager 5 and CDH 5.</li><li><a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html" target="_blank" rel="noopener">Oracle JDK 8</a> is supported in C5.3.x and higher.</li><li>Oracle JDK 9 is not supported in any Cloudera Manager or CDH version.</li></ul></li><li>The <em>same version</em> of the Oracle JDK must be installed on each cluster host.</li><li>The JDK must be installed at <strong>/usr/java/jdk-version</strong>.</li></ul><blockquote><p><strong>Important</strong>:The RHEL-compatible and Ubuntu operating systems supported by Cloudera Enterprise all use AES-256 encryption by default for tickets. To support AES-256 bit encryption in JDK versions lower than <strong>1.8u161</strong>, you must install the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy File</a> on all cluster and Hadoop user machines. Cloudera Manager can automatically install the policy files, or you can install them manually. For JCE Policy File installation instructions, see the README.txtfile included in the jce_policy-x.zip file. JDK 1.8u161 and higher enable unlimited strength encryption by default, and do not require policy files.On SLES platforms, do not install or try to use the IBM Java version bundled with the SLES distribution. CDH does not run correctly with that version.  </p></blockquote><p><strong>根据<a href="https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html#concept_ihg_vf4_j1b" target="_blank" rel="noopener">官方指南</a>因此本次安装选择JDK充分测试过且支持的最高版本JDK1.8u162</strong></p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传下载的jdk到cdh01机器上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动到/opt/java目录下</span></span><br><span class="line">mkdir /usr/java/</span><br><span class="line">tar zxvf jdk-8u162-linux-x64.tar.gz -C /usr/java/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="comment"># 在最末尾加上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for jdk</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/jdk1.8.0_162</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生效环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment"># 检查是否生效</span></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将jdk拷贝到其他节点上去</span></span><br><span class="line">scp -r /usr/java/ cdh02:/usr/</span><br><span class="line">scp -r /usr/java/ cdh03:/usr/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝环境变量到其他节点上去</span></span><br><span class="line">scp /etc/profile cdh02:/etc/</span><br><span class="line">scp /etc/profile cdh03:/etc/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在其他节点检查jdk环境是否生效</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p><img src="images/jdk_version.png" alt="jdk版本"></p><h4 id="3-3-配置ntp"><a href="#3-3-配置ntp" class="headerlink" title="3.3.配置ntp"></a>3.3.配置ntp</h4><p><a href="https://www.cloudera.com/documentation/enterprise/5-15-x/topics/install_cdh_enable_ntp.html" target="_blank" rel="noopener">官方文档</a></p><ul><li><p>安装ntp（所有节点）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntp</span><br></pre></td></tr></table></figure></li><li><p>配置</p><ul><li><p>cdh01节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01主节点配置</span></span><br><span class="line">vi /etc/ntp.conf</span><br><span class="line"><span class="comment"># 注释默认的server,添加以下server</span></span><br><span class="line">server 210.72.145.44 perfer   <span class="comment"># 中国国家受时中心</span></span><br><span class="line">server 202.112.10.36             <span class="comment"># 1.cn.pool.ntp.org</span></span><br><span class="line">server 59.124.196.83             <span class="comment"># 0.asia.pool.ntp.org</span></span><br><span class="line">server  127.127.1.0     <span class="comment"># local clock</span></span><br><span class="line">fudge   127.127.1.0 stratum 10</span><br></pre></td></tr></table></figure></li><li><p>cdh02、cdh03节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ntp.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 子节点把所有server行注释掉，添加下面一行</span></span><br><span class="line">server cdh01</span><br></pre></td></tr></table></figure></li><li><p>所有节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ntpd</span><br><span class="line">systemctl <span class="built_in">enable</span> ntpd</span><br><span class="line">ntpstat</span><br></pre></td></tr></table></figure><blockquote><p>synchronised to NTP server (192.168.31.151) at stratum 12<br>   time correct to within 909 ms<br>   polling server every 64 s</p></blockquote></li></ul></li></ul><h4 id="3-4-cdh01节点安装配置MySQL"><a href="#3-4-cdh01节点安装配置MySQL" class="headerlink" title="3.4.cdh01节点安装配置MySQL"></a>3.4.cdh01节点安装配置MySQL</h4><ul><li>安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum update</span><br><span class="line">yum install mysql-server</span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br><span class="line">cp /etc/my.cnf /etc/my.cnf.default</span><br><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除原有配置，并修改为如下建议配置</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">transaction-isolation = READ-COMMITTED</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks;</span></span><br><span class="line"><span class="comment"># to do so, uncomment this line:</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line"></span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">thread_stack = 256K</span><br><span class="line">thread_cache_size = 64</span><br><span class="line">query_cache_limit = 8M</span><br><span class="line">query_cache_size = 64M</span><br><span class="line">query_cache_type = 1</span><br><span class="line"></span><br><span class="line">max_connections = 550</span><br><span class="line"><span class="comment">#expire_logs_days = 10</span></span><br><span class="line"><span class="comment">#max_binlog_size = 100M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#log_bin should be on a disk with enough free space.</span></span><br><span class="line"><span class="comment">#Replace '/var/lib/mysql/mysql_binary_log' with an appropriate path for your</span></span><br><span class="line"><span class="comment">#system and chown the specified folder to the mysql user.</span></span><br><span class="line">log_bin=/var/lib/mysql/mysql_binary_log</span><br><span class="line"></span><br><span class="line"><span class="comment">#In later versions of MySQL, if you enable the binary log and do not set</span></span><br><span class="line"><span class="comment">#a server_id, MySQL will not start. The server_id must be unique within</span></span><br><span class="line"><span class="comment">#the replicating group.</span></span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line">binlog_format = mixed</span><br><span class="line"></span><br><span class="line">read_buffer_size = 2M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">sort_buffer_size = 8M</span><br><span class="line">join_buffer_size = 8M</span><br><span class="line"></span><br><span class="line"><span class="comment"># InnoDB settings</span></span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_flush_log_at_trx_commit  = 2</span><br><span class="line">innodb_log_buffer_size = 64M</span><br><span class="line">innodb_buffer_pool_size = 4G</span><br><span class="line">innodb_thread_concurrency = 8</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_log_file_size = 512M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">sql_mode=STRICT_ALL_TABLES</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><ul><li>设置root密码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/mysql_secure_installation</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line">[...]</span><br><span class="line">Set root password? [Y/n] Y</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">Remove anonymous users? [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Disallow root login remotely? [Y/n] N</span><br><span class="line">[...]</span><br><span class="line">Remove <span class="built_in">test</span> database and access to it [Y/n] Y</span><br><span class="line">[...]</span><br><span class="line">Reload privilege tables now? [Y/n] Y</span><br><span class="line">All <span class="keyword">done</span>!</span><br></pre></td></tr></table></figure><ul><li>安装配置MySQL JDBC 驱动</li></ul><p>下载 .tar.gz格式的文件地址：<a href="http://www.mysql.com/downloads/connector/j/5.1.html" target="_blank" rel="noopener">http://www.mysql.com/downloads/connector/j/5.1.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf mysql-connector-java-5.1.47.tar.gz</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/share/java/</span><br><span class="line"></span><br><span class="line">cp mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar \</span><br><span class="line"> /usr/share/java/mysql-connector-java.jar</span><br><span class="line"> </span><br><span class="line">scp -r /usr/share/java/ cdh02:/usr/share/</span><br><span class="line">scp -r /usr/share/java/ cdh03:/usr/share/</span><br></pre></td></tr></table></figure><ul><li>创建对应服务数据库</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE hue DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON hue.* TO &apos;hue&apos;@&apos;%&apos; IDENTIFIED BY &apos;hue&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE metastore DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON metastore.* TO &apos;hive&apos;@&apos;%&apos; IDENTIFIED BY &apos;hive&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE sentry DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON sentry.* TO &apos;sentry&apos;@&apos;%&apos; IDENTIFIED BY &apos;sentry&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE oozie DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON oozie.* TO &apos;oozie&apos;@&apos;%&apos; IDENTIFIED BY &apos;oozie&apos;;</span><br><span class="line"></span><br><span class="line">CREATE DATABASE am DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">GRANT ALL ON am.* TO &apos;am&apos;@&apos;%&apos; IDENTIFIED BY &apos;am&apos;;</span><br></pre></td></tr></table></figure><h4 id="3-5-创建用户-cloudera-scm-（-所有-节点）"><a href="#3-5-创建用户-cloudera-scm-（-所有-节点）" class="headerlink" title="3.5. 创建用户 cloudera-scm （ 所有 节点）"></a>3.5. 创建用户 cloudera-scm （ 所有 节点）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd --system --home=/opt/cm-5.15.1/run/cloudera-scm-server/ --no-create-home --bash=/bin/<span class="literal">false</span> --comment <span class="string">"Cloudera SCM User"</span> cloudera-scm</span><br></pre></td></tr></table></figure><h4 id="3-6-解压CM包"><a href="#3-6-解压CM包" class="headerlink" title="3.6.解压CM包"></a>3.6.解压CM包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">mkdir -p /opt/cloudera/parcel-repo</span><br><span class="line">tar -zxvf cloudera-manager-centos7-cm5.15.1_x86_64.tar.gz -C /opt/</span><br><span class="line">mv CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel.sha CDH-5.15.1-1.cdh5.15.1.p0.4-el7.parcel manifest.json /opt/cloudera/parcel-repo/</span><br><span class="line"></span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cm-5.15.1/</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cloudera/</span><br><span class="line">mkdir /var/lib/cloudera-scm-server</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-server</span><br></pre></td></tr></table></figure><h4 id="3-7-修改agent配置"><a href="#3-7-修改agent配置" class="headerlink" title="3.7.修改agent配置"></a>3.7.修改agent配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">vi /opt/cm-5.15.1/etc/cloudera-scm-agent/config.ini</span><br><span class="line">server_host=cdh01</span><br></pre></td></tr></table></figure><h4 id="3-8-拷贝CM包到所有节点"><a href="#3-8-拷贝CM包到所有节点" class="headerlink" title="3.8.拷贝CM包到所有节点"></a>3.8.拷贝CM包到所有节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">scp -r /opt/cm-5.15.1/ cdh02:/opt/</span><br><span class="line">scp -r /opt/cm-5.15.1/ cdh03:/opt/</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh02、cdh03节点</span></span><br><span class="line">mkdir -p /opt/cloudera/parcel-repo</span><br><span class="line">chown -R cloudera-scm:cloudera-scm /opt/cloudera/</span><br></pre></td></tr></table></figure><h4 id="3-9-cdh01节点初始化数据库"><a href="#3-9-cdh01节点初始化数据库" class="headerlink" title="3.9.cdh01节点初始化数据库"></a>3.9.cdh01节点初始化数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点</span></span><br><span class="line">/opt/cm-5.15.1/share/cmf/schema/scm_prepare_database.sh mysql -hlocalhost -uroot -p123456 --scm-host localhost scm scm scm</span><br></pre></td></tr></table></figure><h4 id="3-10-启动服务"><a href="#3-10-启动服务" class="headerlink" title="3.10.启动服务"></a>3.10.启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cdh01节点启动cm服务端</span></span><br><span class="line">/opt/cm-5.15.1/etc/init.d/cloudera-scm-server start</span><br><span class="line"><span class="comment"># 查看启动日志</span></span><br><span class="line">tail -f /opt/cm-5.15.1/<span class="built_in">log</span>/cloudera-scm-server/cloudera-scm-server.log </span><br><span class="line"><span class="comment"># 查看到如下日志服务启动完成</span></span><br><span class="line">com.cloudera.server.cmf.WebServerImpl: Started Jetty server.</span><br><span class="line"></span><br><span class="line"><span class="comment"># cdh01、cdh02、cdh03节点启动客户端</span></span><br><span class="line">/opt/cm-5.15.1/etc/init.d/cloudera-scm-agent start</span><br></pre></td></tr></table></figure><h4 id="3-11-初始化CM"><a href="#3-11-初始化CM" class="headerlink" title="3.11.初始化CM"></a>3.11.初始化CM</h4><ul><li><p>访问CM web界面</p><p><a href="http://192.168.31.151:7180/" target="_blank" rel="noopener">http://192.168.31.151:7180/</a></p><p>用户：admin</p><p>密码：admin</p></li><li><p>配置CM</p><p><img src="images/cm01.png" alt></p><p><img src="images/cm02.png" alt></p><p><img src="images/cm03.png" alt></p><p><img src="images/cm04.png" alt></p></li></ul><p><img src="images/cm05.png" alt>    </p><p><img src="images/cm06.png" alt></p><p><strong>此处会报两个错误：内存交换空间设置和启用了透明大页面压缩，点击【查看详细信息】查看需要修改设置的主机</strong> </p><ul><li><p>将机器设置成cloudera官方建议的配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sysctl vm.swappiness=10</span><br><span class="line"></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/sysctl.conf加入或修改vm.swappiness配置</span></span><br><span class="line">vm.swappiness=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag'</span> &gt;&gt; /etc/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.local</span><br><span class="line">cat /etc/rc.local</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br></pre></td></tr></table></figure><p><strong>修改完成重新运行检查主机检查，此时警告消除点击【完成】。</strong></p></li></ul><h3 id="4-安装CDH服务"><a href="#4-安装CDH服务" class="headerlink" title="4.安装CDH服务"></a>4.安装CDH服务</h3><ul><li>选择服务</li></ul><p><img src="images/cdh01.png" alt></p><ul><li>配置角色</li></ul><p><img src="images/cdh02.png" alt></p><ul><li>设置数据库连接</li></ul><p><img src="images/cdh03.png" alt></p><ul><li>集群设置</li></ul><p><img src="images/cdh04.png" alt></p><ul><li>开始安装</li></ul><p><img src="images/cdh05.png" alt></p><ul><li>完成安装</li></ul><p><img src="images/cdh06.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Centos7离线部署-CDH5&quot;&gt;&lt;a href=&quot;#Centos7离线部署-CDH5&quot; class=&quot;headerlink&quot; title=&quot;Centos7离线部署 CDH5&quot;&gt;&lt;/a&gt;Centos7离线部署 CDH5&lt;/h2&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h3 
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/CDH6.0.0update6.1.0/CDH6.0.0%E4%B8%8D%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A76.1.0/"/>
    <id>http://yoursite.com/2019/02/16/CDH6.0.0update6.1.0/CDH6.0.0不停止服务升级6.1.0/</id>
    <published>2019-02-16T15:32:13.079Z</published>
    <updated>2019-02-17T04:32:49.691Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CDH6-0-0升级6-1-0步骤"><a href="#CDH6-0-0升级6-1-0步骤" class="headerlink" title="CDH6.0.0升级6.1.0步骤"></a>CDH6.0.0升级6.1.0步骤</h2><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_overview.html" target="_blank" rel="noopener">官方文档</a></p><p><a href="https://cloud.tencent.com/developer/article/1077573" target="_blank" rel="noopener">参考文档</a></p><p>[TOC]</p><h3 id="1-CM升级"><a href="#1-CM升级" class="headerlink" title="1.CM升级"></a>1.CM升级</h3><h4 id="1-1-升级概述"><a href="#1-1-升级概述" class="headerlink" title="1.1.升级概述"></a>1.1.升级概述</h4><p><img src="images/cm01.png" alt></p><p>升级CDH集群，可以通过Cloudera Manager使用Cloudera parcels升级整个集群，也可以在所有群集主机使用基于RPM包的命令手动安装软件，然后Cloudera Manager完成服务升级。</p><p>可以不同时升级Cloudera Manager和CDH，但Cloudera Manager和CDH的版本必须兼容，Cloudera Manager的主要+次要版本等于或高于CDH的主要+次要版本。</p><h4 id="1-2-下载文件"><a href="#1-2-下载文件" class="headerlink" title="1.2.下载文件"></a>1.2.下载文件</h4><p><a href="https://archive.cloudera.com/cm6/" target="_blank" rel="noopener">CM6.1.0</a></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/" target="_blank" rel="noopener">北京IDC内网地址</a></p><h4 id="1-3-备份"><a href="#1-3-备份" class="headerlink" title="1.3.备份"></a>1.3.备份</h4><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_before.html" target="_blank" rel="noopener">官方文档</a></p><h5 id="1-3-1-收集信息"><a href="#1-3-1-收集信息" class="headerlink" title="1.3.1.收集信息"></a>1.3.1.收集信息</h5><ul><li>操作系统信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure><ul><li>查看数据库配置信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/cloudera-scm-server/db.properties</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/cloudera-scm-server/db.properties</span></span><br><span class="line"><span class="comment"># Auto-generated by scm_prepare_database.sh on Thu Dec  6 18:42:08 CST 2018</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For information describing how to configure the Cloudera Manager Server</span></span><br><span class="line"><span class="comment"># to connect to databases, see the "Cloudera Manager Installation Guide."</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">com.cloudera.cmf.db.type=mysql</span><br><span class="line">com.cloudera.cmf.db.host=localhost</span><br><span class="line">com.cloudera.cmf.db.name=scm</span><br><span class="line">com.cloudera.cmf.db.user=scm</span><br><span class="line">com.cloudera.cmf.db.setupType=EXTERNAL</span><br><span class="line">com.cloudera.cmf.db.password=scm</span><br></pre></td></tr></table></figure><h5 id="1-3-2-备份CM-Agent"><a href="#1-3-2-备份CM-Agent" class="headerlink" title="1.3.2.备份CM Agent"></a>1.3.2.备份CM Agent</h5><ul><li>创建备份目录 （在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CM_BACKUP_DIR=<span class="string">"`date +%F`-CM6.0.0"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CM_BACKUP_DIR</span></span><br><span class="line">mkdir backup</span><br><span class="line"><span class="built_in">cd</span> backup</span><br><span class="line">mkdir -p <span class="variable">$CM_BACKUP_DIR</span></span><br></pre></td></tr></table></figure><ul><li>备份CM Agent当前运行状态（在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/cloudera-scm-agent.tar --exclude=*.sock /etc/cloudera-scm-agent /etc/default/cloudera-scm-agent /var/run/cloudera-scm-agent /var/lib/cloudera-scm-agent</span><br></pre></td></tr></table></figure><blockquote><p>The tar commands in the steps below may return the following message. It is safe to ignore thismessage:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; tar: Removing leading `/&apos; from member names</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p><img src="images/cm02.png" alt></p><p><img src="images/cm03.png" alt></p><ul><li>备份yum源（在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/repository.tar /etc/yum.repos.d</span><br></pre></td></tr></table></figure><p><img src="images/cm04.png" alt></p><h5 id="1-3-3-备份Cloudera-Management-Service"><a href="#1-3-3-备份Cloudera-Management-Service" class="headerlink" title="1.3.3.备份Cloudera Management Service"></a>1.3.3.备份Cloudera Management Service</h5><ul><li>在Service Monitor role 机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-service-monitor /var/lib/cloudera-service-monitor-`date +%F`-CM6.0.0</span><br><span class="line"><span class="comment">## 如果自定义了目录需要修改为自定义的目录</span></span><br></pre></td></tr></table></figure><p><img src="images/cm05.png" alt></p><ul><li>在Host Monitor role机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-host-monitor /var/lib/cloudera-host-monitor-`date +%F`-CM6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cm06.png" alt></p><ul><li>在 Event Server role机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-scm-eventserver /var/lib/cloudera-scm-eventserver-`date +%F`-CM6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cm07.png" alt></p><h5 id="1-3-4-停止CM相关服务"><a href="#1-3-4-停止CM相关服务" class="headerlink" title="1.3.4.停止CM相关服务"></a>1.3.4.停止CM相关服务</h5><ul><li>停止Cloudera Management Service</li></ul><p><strong>登录CM管理界面操作</strong></p><p><img src="images/cm08.png" alt></p><p><img src="images/cm09.png" alt></p><ul><li>停止Cloudera Manager Server （CM机器上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop cloudera-scm-server</span><br></pre></td></tr></table></figure><p><img src="images/cm10.png" alt></p><h5 id="1-3-5-备份CM数据库（mysql机器上执行）"><a href="#1-3-5-备份CM数据库（mysql机器上执行）" class="headerlink" title="1.3.5.备份CM数据库（mysql机器上执行）"></a>1.3.5.备份CM数据库（mysql机器上执行）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --databases scm --host=localhost --port=3306 -u scm -p &gt; <span class="variable">$HOME</span>/scm-backup-`date +%F`-CM6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cm11.png" alt></p><h5 id="1-3-6-备份CM其他相关服务的数据库（mysql机器上执行）"><a href="#1-3-6-备份CM其他相关服务的数据库（mysql机器上执行）" class="headerlink" title="1.3.6.备份CM其他相关服务的数据库（mysql机器上执行）"></a>1.3.6.备份CM其他相关服务的数据库（mysql机器上执行）</h5><p><img src="images/cm12.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --databases am --host=localhost --port=3306 -u am -p &gt; <span class="variable">$HOME</span>/am-backup-`date +%F`-CM6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cm13.png" alt></p><h5 id="1-3-7-备份Cloudera-Manager-Server（CM机器上执行）"><a href="#1-3-7-备份Cloudera-Manager-Server（CM机器上执行）" class="headerlink" title="1.3.7.备份Cloudera Manager Server（CM机器上执行）"></a>1.3.7.备份Cloudera Manager Server（CM机器上执行）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/cloudera-scm-server.tar /etc/cloudera-scm-server /etc/default/cloudera-scm-server</span><br></pre></td></tr></table></figure><p><img src="images/cm14.png" alt></p><h4 id="1-4-升级Cloudera-Manager-Server"><a href="#1-4-升级Cloudera-Manager-Server" class="headerlink" title="1.4.升级Cloudera Manager Server"></a>1.4.升级Cloudera Manager Server</h4><ul><li>删除yum源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/cloudera*manager.repo*</span><br></pre></td></tr></table></figure><p><img src="images/cm15.png" alt></p><ul><li>添加新的yum源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/cloudera-manager.repo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[cloudera-repo]</span><br><span class="line">name=cloudera-repo</span><br><span class="line">baseurl=http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/redhat7/yum/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean  all</span><br><span class="line">rm -rf /var/cache/yum</span><br><span class="line">yum  repolist</span><br></pre></td></tr></table></figure><p><img src="images/cm16.png" alt></p><ul><li>停止cloudera-scm-agent服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop cloudera-scm-agent</span><br></pre></td></tr></table></figure><ul><li>升级CM</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent</span><br></pre></td></tr></table></figure><p><strong>如果弹出更新配置文件选项选择N</strong></p><blockquote><p>You might be prompted about your configuration file version:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configuration file &apos;/etc/cloudera-scm-agent/config.ini&apos;</span><br><span class="line">&gt; ==&gt; Modified (by you or by a script) since installation.</span><br><span class="line">&gt; ==&gt; Package distributor has shipped an updated version.</span><br><span class="line">&gt; What would you like to do about it ? Your options are:</span><br><span class="line">&gt; Y or I : install the package maintainer&apos;s version</span><br><span class="line">&gt; N or O : keep your currently-installed version</span><br><span class="line">&gt; D : show the differences between the versions</span><br><span class="line">&gt; Z : start a shell to examine the situation</span><br><span class="line">&gt; The default action is to keep your current version.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>You may receive a similar prompt for /etc/cloudera-scm-server/db.properties. Answer <strong>N</strong> to both prompts.</p><p>You may be prompted to accept the GPG key. Answer <strong>y</strong>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; Retrieving key from https://archive.cloudera.com/.../cm/RPM-GPG-KEY-cloudera</span><br><span class="line">&gt; Importing GPG key ...</span><br><span class="line">&gt;  Userid     : &quot;Yum Maintainer &lt;webmaster@cloudera.com&gt;&quot;</span><br><span class="line">&gt;  Fingerprint: ...</span><br><span class="line">&gt;  From       : https://archive.cloudera.com/.../RPM-GPG-KEY-cloudera</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p><img src="images/cm17.png" alt></p><ul><li>检查安装的包是否正确</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa <span class="string">'cloudera-manager-*'</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cloudera-manager-server-6.1.0-769885.el7.x86_64</span><br><span class="line">cloudera-manager-daemons-6.1.0-769885.el7.x86_64</span><br><span class="line">cloudera-manager-agent-6.1.0-769885.el7.x86_64</span><br></pre></td></tr></table></figure><p><img src="images/cm18.png" alt></p><ul><li>启动服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start cloudera-scm-agent</span><br><span class="line">systemctl start cloudera-scm-server</span><br></pre></td></tr></table></figure><ul><li>检查日志</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-server/cloudera-scm-server.log</span><br><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-agent/cloudera-scm-agent.log</span><br></pre></td></tr></table></figure><p><img src="images/cm19.png" alt></p><ul><li>登录CM管理平台<a href="http://10.240.9.132:7180自动运行升级向导" target="_blank" rel="noopener">http://10.240.9.132:7180自动运行升级向导</a></li></ul><p><img src="images/cm21.png" alt></p><p><img src="images/cm22.png" alt></p><p>输入升级源</p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/" target="_blank" rel="noopener">http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/</a></p><p><img src="images/cm23.png" alt></p><p><img src="images/cm24.png" alt></p><p><img src="images/cm25.png" alt></p><p><img src="images/cm26.png" alt></p><p><img src="images/cm27.png" alt></p><p><img src="images/cm28.png" alt></p><p><img src="images/cm29.png" alt></p><p><img src="images/cm30.png" alt></p><p><img src="images/cm31.png" alt></p><p><img src="images/cm32.png" alt></p><p><img src="images/cm33.png" alt></p><p>Cloudera Manager在升级后报告过时的配置，请重新启动集群服务并重新部署客户端配置</p><p><img src="images/cm34.png" alt></p><p><img src="images/cm35.png" alt></p><p><img src="images/cm36.png" alt></p><p><img src="images/cm37.png" alt></p><ul><li><p>检查升级结果</p><p><strong>查看Cloudera Manager版本</strong></p></li></ul><p><img src="images/cm38.png" alt></p><p><img src="images/cm39.png" alt></p><p><strong>验证Agent是否向Cloudera Manager发送心跳</strong></p><p><img src="images/cm40.png" alt></p><p><strong>检查所有主机</strong></p><p><img src="images/cm41.png" alt></p><p><img src="images/cm42.png" alt></p><p><strong>查看检查结果</strong></p><p><img src="images/cm43.png" alt></p><p><strong>检查集群历史监控数据</strong></p><p><img src="images/cm44.png" alt></p><p><strong>至此CM升级成功。</strong></p><h3 id="2-CDH升级"><a href="#2-CDH升级" class="headerlink" title="2.CDH升级"></a>2.CDH升级</h3><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cdh_upgrade_before.html" target="_blank" rel="noopener">官方文档</a></p><h4 id="2-1-准备安装包"><a href="#2-1-准备安装包" class="headerlink" title="2.1.准备安装包"></a>2.1.准备安装包</h4><p><a href="https://archive.cloudera.com/cdh6/6.1.0/" target="_blank" rel="noopener">官方CDH6.1.0下载地址</a></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cdh/" target="_blank" rel="noopener">北京IDC内网地址</a></p><h4 id="2-2-服务检查"><a href="#2-2-服务检查" class="headerlink" title="2.2.服务检查"></a>2.2.服务检查</h4><ul><li>HDFS检查</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录任意一个节点，检查HDFS是否有错误，有错误修改后继续</span></span><br><span class="line">sudo -u hdfs hdfs fsck / -includeSnapshots</span><br><span class="line">sudo -u hdfs hdfs dfsadmin -report</span><br></pre></td></tr></table></figure><p><img src="images/cdh03.png" alt><img src="images/cdh04.png" alt></p><ul><li>HBase检查</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录任意一个DataNode节点，执行如下命令检查，有错误的话，修正错误后继续</span></span><br><span class="line">sudo -u hdfs hbase hbck</span><br></pre></td></tr></table></figure><p><img src="images/cdh05.png" alt></p><ul><li>KUDU检查</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行如下命令检查，有错误的话，修正错误后继续</span></span><br><span class="line"><span class="comment"># kudu kudu cluster ksck kudu_master_host1,ksck kudu_master_host2</span></span><br><span class="line">sudo -u kudu kudu cluster ksck bjds-bi-odp-prd-10-240-9-132-belle.lan</span><br></pre></td></tr></table></figure><p><img src="images/cdh06.png" alt></p><h4 id="2-3-进入维护模式"><a href="#2-3-进入维护模式" class="headerlink" title="2.3.进入维护模式"></a>2.3.进入维护模式</h4><p>1.CM首选选择进入维护模式</p><p>2.升级预处理</p><ul><li><p>Ensure that new applications, such as MapReduce or Spark applications, will not be submitted to the cluster until the upgrade is complete.</p></li><li><p>In the Cloudera Manager Admin Console, navigate to the YARN service for the cluster you are upgrading.</p></li><li><p>On the <strong>Instances</strong> tab, select all the <strong>NodeManager</strong> roles. This can be done by filtering for the roles under <strong>Role Type</strong>.</p></li><li><p>Click Actions for Selected (number) &gt; Decommission.<br>If the cluster runs CDH 5.9 or higher and is managed by Cloudera Manager 5.9 or higher, and you configured graceful decommission, the countdown for the timeout starts.</p><p>A Graceful Decommission provides a timeout before starting the decommission process. The timeout creates a window of time to drain already running workloads from the system and allow them to run to completion. Search for the Node Manager Graceful Decommission Timeout field on the Configuration tab for the YARN service, and set the property to a value greater than 0 to create a timeout.</p></li><li><p>Wait for the decommissioning to complete. The NodeManager State is Stopped and the Commission State is Decommissioned when decommissioning completes for each NodeManager.</p></li><li><p>With all the NodeManagers still selected, click <strong>Actions for Selected (number)</strong> &gt; <strong>Recommission</strong>.</p></li></ul><p><strong>Important:</strong> Do not start the NodeManagers.</p><p><img src="images/cdh01.png" alt></p><p><img src="images/cdh02.png" alt></p><h4 id="2-4-备份数据库"><a href="#2-4-备份数据库" class="headerlink" title="2.4.备份数据库"></a>2.4.备份数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份hue</span></span><br><span class="line">mysqldump --databases hue --host=localhost --port=3306 -u hue -p &gt; hue-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份hive元数据</span></span><br><span class="line">mysqldump --databases metastore --host=localhost --port=3306 -u hive -p &gt; metastore-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份oozie</span></span><br><span class="line">mysqldump --databases oozie --host=localhost --port=3306 -u oozie -p &gt; oozie-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份sentry</span></span><br><span class="line">mysqldump --databases sentry --host=localhost --port=3306 -u sentry -p &gt; sentry-backup-`date +%F`-CDH6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cdh07.png" alt></p><p><img src="images/cdh08.png" alt></p><h4 id="2-5-备份ZooKeeper-所有节点"><a href="#2-5-备份ZooKeeper-所有节点" class="headerlink" title="2.5.备份ZooKeeper(所有节点)"></a>2.5.备份ZooKeeper(所有节点)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/zookeeper/ /var/lib/zookeeper-backup-`date +%F`CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cdh09.png" alt></p><h4 id="2-6-备份数据"><a href="#2-6-备份数据" class="headerlink" title="2.6.备份数据"></a>2.6.备份数据</h4><ul><li>启用了HA的HDFS需要登录<strong>所有的JournalNode节点备份</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /data/dfs/jn /data/dfs/jn-CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cdh10.png" alt></p><ul><li>备份<strong>所有的NameNode节点</strong>运行状态</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/hadoop/conf.rollback.namenode</span><br><span class="line"><span class="built_in">cd</span> /var/run/cloudera-scm-agent/process/ &amp;&amp; <span class="built_in">cd</span> `ls -t1 | grep -e <span class="string">"-NAMENODE\$"</span> | head -1`</span><br><span class="line">cp -rp * /etc/hadoop/conf.rollback.namenode/</span><br><span class="line">rm -rf /etc/hadoop/conf.rollback.namenode/log4j.properties</span><br><span class="line">cp -rp /etc/hadoop/conf.cloudera.hdfs/log4j.properties /etc/hadoop/conf.rollback.namenode/</span><br></pre></td></tr></table></figure><p><img src="images/cdh11.png" alt></p><ul><li>备份NameNode的元数据（所有namenode主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -czvf <span class="variable">$CM_BACKUP_DIR</span>/nn_backup.tar.gz  /data/dfs/nn/</span><br></pre></td></tr></table></figure><p><img src="images/cdh13.png" alt></p><ul><li>备份<strong>所有的DataNode</strong>运行状态（所有运行DataNode主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/hadoop/conf.rollback.datanode/</span><br><span class="line"><span class="built_in">cd</span> /var/run/cloudera-scm-agent/process/ &amp;&amp; <span class="built_in">cd</span> `ls -t1 | grep -e <span class="string">"-DATANODE\$"</span> | head -1`</span><br><span class="line">cp -rp * /etc/hadoop/conf.rollback.datanode/</span><br><span class="line">rm -rf /etc/hadoop/conf.rollback.datanode/log4j.properties</span><br><span class="line">cp -rp /etc/hadoop/conf.cloudera.hdfs/log4j.properties /etc/hadoop/conf.rollback.datanode/</span><br></pre></td></tr></table></figure><p><img src="images/cdh12.png" alt></p><ul><li>备份Hue，所有的Hue Server主机</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在所有的Hue Server角色上运行</span></span><br><span class="line">mkdir -p /opt/cloudera/parcels_backup</span><br><span class="line">cp -rp /opt/cloudera/parcels/CDH/lib/hue/app.reg /opt/cloudera/parcels_backup/app.reg-CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><h4 id="2-7-向集群中添加新版的CDH存储库"><a href="#2-7-向集群中添加新版的CDH存储库" class="headerlink" title="2.7.向集群中添加新版的CDH存储库"></a>2.7.向集群中添加新版的CDH存储库</h4><p><img src="images/cdh14.png" alt></p><p><img src="images/cdh18.png" alt></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cdh/" target="_blank" rel="noopener">http://10.240.9.132:8900/CDH6.1.0/cdh/</a></p><p><img src="images/cdh17.png" alt></p><h4 id="2-8-运行升级向导开始升级"><a href="#2-8-运行升级向导开始升级" class="headerlink" title="2.8.运行升级向导开始升级"></a>2.8.运行升级向导开始升级</h4><p><img src="images/cdh19.png" alt></p><p><img src="images/cdh20.png" alt></p><p><img src="images/cdh21.png" alt></p><p><img src="images/cdh22.png" alt></p><p><img src="images/cdh23.png" alt></p><p><img src="/Users/yangqian/Desktop/cdh24.png" alt></p><p><img src="images/cdh25.png" alt></p><p><img src="images/26.png" alt></p><p><img src="images/cdh27.png" alt></p><p><img src="images/cdh28.png" alt></p><h4 id="2-9-功能验证"><a href="#2-9-功能验证" class="headerlink" title="2.9.功能验证"></a>2.9.功能验证</h4><ul><li>运行一个MR任务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u hdfs hadoop jar  /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar  pi 10 100</span><br></pre></td></tr></table></figure><p><img src="images/cdh29.png" alt></p><p><img src="images/cdh30.png" alt></p><p><img src="images/cdh31.png" alt></p><ul><li>Hue测试</li></ul><p>检查原有数据</p><p>CDH6.0.0的数据</p><p><img src="images/old.png" alt></p><p>升级CDH6.1.0后的数据</p><p><img src="images/new.png" alt></p><p>创建数据库</p><p><img src="images/cdh33.png" alt></p><p>创建表和插入数据</p><p><img src="images/cdh34.png" alt></p><h4 id="2-10-最终化元数据升级"><a href="#2-10-最终化元数据升级" class="headerlink" title="2.10.最终化元数据升级"></a>2.10.最终化元数据升级</h4><p><strong>在最终化元数据之前，进行几天甚至几周的运行观察集群是否正常，在发现所有任务都没有任何异常情况后，再进行最终化元数据操作。一旦进行最终化元数据之后，就不能回滚到老的版本了，除非有数据备份。对NameNode的主备节点都执行最终化元数据升级操作：</strong></p><p><img src="images/cdh35.png" alt></p><h3 id="3-CDH回滚"><a href="#3-CDH回滚" class="headerlink" title="3.CDH回滚"></a>3.CDH回滚</h3><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/install_rollback.html" target="_blank" rel="noopener">官方文档</a></p><p><a href="https://cloud.tencent.com/developer/article/1078827" target="_blank" rel="noopener">参考文档</a></p><h4 id="3-1-回滚限制"><a href="#3-1-回滚限制" class="headerlink" title="3.1.回滚限制"></a>3.1.回滚限制</h4><ul><li><strong>HDFS</strong> - 不能对进行过<strong>最终化元数据升级（2.10步骤）</strong>的HDFS集群进行回滚。</li><li><strong>集群升级后的配置变化将不会被保留</strong> - 包括升级后的角色、服务的变更。Cloudera 的建议是最终化元数据升级后再进行集群角色和服务的变更。</li><li><strong>HBase</strong> – If your cluster is configured to use HBase replication, data written to HBase after the upgrade might not be replicated to peers when you start your rollback. This topic does not describe how to determine which, if any, peers have the replicated data and how to roll back that data. For more information about HBase replication, see <a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/cdh_bdr_hbase_replication.html#topic_20_11" target="_blank" rel="noopener">HBase Replication</a>.</li><li><strong>Sqoop 1</strong> – Because of the changes introduced in Sqoop metastore logic, the metastore database that is created by the CDH 6.x version of Sqoop cannot be used by earlier versions.</li><li><strong>Sqoop 2</strong> – As described in the upgrade process, Sqoop2 had to be stopped and deleted before the upgrade process and therefore will not be available after the rollback.</li><li><strong>Kafka</strong> – Once the Kafka log format and protocol version configurations (the inter.broker.protocol.version and log.message.format.version properties) are set to the new version (or left blank, which means to use the latest version), <em>Kafka rollback is not possible</em>.</li></ul><h4 id="3-2-停止服务"><a href="#3-2-停止服务" class="headerlink" title="3.2.停止服务"></a>3.2.停止服务</h4><p><img src="images/cdh01.png" alt></p><p><img src="images/cdh02.png" alt></p><h4 id="3-3-回滚CDH"><a href="#3-3-回滚CDH" class="headerlink" title="3.3.回滚CDH"></a>3.3.回滚CDH</h4><ul><li>回滚Parcel</li></ul><p><img src="images/rb01.png" alt></p><p><img src="images/rb02.png" alt></p><p><img src="images/rb02-1.png" alt></p><p><img src="images/rb03.png" alt></p><p><strong>点击激活会弹出对话框，选择第二个选项，仅激活，如果不小心选择了第一个选项，开始下面步骤前，先停止服务。</strong></p><ul><li>还原ZooKeeper（所有主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /var/lib/zookeeper/</span><br><span class="line">cp -rp /var/lib/zookeeper-backup-`date +%F`CM6.1.0-CDH6.0.0 /var/lib/zookeeper</span><br></pre></td></tr></table></figure><p>通过CM启动zookeeper</p><ul><li><p>回滚HDFS</p><ul><li>对于开启了HA的HDFS回滚Journal Nodes</li></ul><ol><li><p>登录每个Journal Node节点主机，运行下面命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /data/dfs/jn/nameservice1/current/*</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /data/dfs/jn-CM6.1.0-CDH6.0.0/nameservice1/current/* /data/dfs/jn/nameservice1/current/</span><br></pre></td></tr></table></figure></li><li><p>通过CM启动JournalNodes角色</p><p><img src="images/rb04.png" alt></p></li></ol><p><img src="images/rb05.png" alt></p><p><img src="images/rb06.png" alt></p><ul><li><p>回滚 NameNode（NameNode角色主机执行）</p><ul><li><p>编辑<code>/etc/hadoop/conf.rollback.namenode/hdfs-site.xml</code>文件</p><p>a. 删除  <code>cloudera.navigator.client.config</code> 配置项</p><p>b. 删除<code>dfs.namenode.audit.loggers</code> 配置项</p><p>c. 按如下格式编辑 <code>dfs.hosts</code> 配置项 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original version of the dfs.hosts property:</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;dfs.hosts&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/var/run/cloudera-scm-agent/process/63-hdfs-NAMENODE/dfs_all_hosts.txt&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New version of the dfs.hosts property:</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;dfs.hosts&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/etc/hadoop/conf.rollback.namenode/dfs_all_hosts.txt&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>编辑<code>/etc/hadoop/conf.rollback.namenode/core-site.xml</code>文件，按如下格式修改<code>net.topology.script.file.name</code>配置项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original property</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;net.topology.script.file.name&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/var/run/cloudera-scm-agent/process/63-hdfs-NAMENODE/topology.py&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>按如下格式编辑<code>/etc/hadoop/conf.rollback.namenode/topology.py</code>文件的<code>MAP_FILE</code>项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAP_FILE = <span class="string">'/etc/hadoop/conf.rollback.namenode/topology.map'</span></span><br></pre></td></tr></table></figure></li><li><p>执行下面命令回滚:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.namenode namenode -rollback</span><br></pre></td></tr></table></figure><p><strong>有可能报错建立目录失败，手动建立下日志目录，并修改下目录权限777，然后执行回滚，回滚会提示是否需要回滚，选择Y，最后提前启动Namenode失败，继续执行下面步骤</strong></p></li><li><p>通过CM重启所有的NameNodes 和 JournalNodes 实例</p><p><img src="images/rb07.png" alt></p></li></ul></li><li><p>回滚DataNode</p><ul><li><p>编辑<code>/etc/hadoop/conf.rollback.datanode/hdfs-site.xml</code> 移除<code>dfs.datanode.max.locked.memory</code>属性</p></li><li><p>运行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/cloudera/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114/lib/hadoop/logs</span><br><span class="line">chmod 777 /opt/cloudera/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114/lib/hadoop/logs</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/hadoop/conf.rollback.datanode</span><br><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.datanode datanode -rollback</span><br></pre></td></tr></table></figure><p><img src="images/rb08.png" alt></p><p><img src="images/rb09.png" alt></p><p>回滚完成后通过<code>CTRL</code> + <code>C</code>返回终端</p><p><img src="images/rb10.png" alt></p></li><li><p>对于HA的HDFS，通过CM重启HDFS服务，非HA的HDFS重启所有的DataNode角色。</p></li><li><p>(非HA的HDFS回滚Secondary NameNode )If high availability is not enabled for HDFS, roll back the Secondary NameNode.</p><ol><li><p>(Clusters with TLS enabled only) Edit the<code>/etc/hadoop/conf.rollback.secondarynamenode/ssl-server.xml</code></p><p>file on all Secondary NameNode hosts (Located in the temporary rollback directory.) and update the keystore passwords with the actual cleartext passwords.</p><p>The passwords will have values that look like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;ssl.server.keystore.password&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;********&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;ssl.server.keystore.keypassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;********&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>(TLS only) Edit the /etc/hadoop/conf.rollback.secondarynamenode/ssl-server.xml file and remove the hadoop.security.credential.provider.path property.</p></li><li><p>Log in to the Secondary NameNode host and run the following commands:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /dfs/snn/*</span><br><span class="line">cd /etc/hadoop/conf.rollback.secondarynamenode/</span><br><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.secondarynamenode secondarynamenode -format</span><br></pre></td></tr></table></figure></li></ol><p>Restart the HDFS service. Open the Cloudera Manager Admin Console, go to the HDFS service page, and select Actions &gt; Restart.</p><p>The Restart Command page displays the progress of the restart. Wait for the page to display the Successfully restarted service message before continuing.</p></li></ul></li></ul></li><li><p>启动HBase服务</p><p>通过CM直接启动HBase服务</p></li><li><p>回滚数据库</p><ul><li>Hive Metastore</li><li>Hue</li><li>Oozie</li><li>Sentry Server</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还原hue</span></span><br><span class="line">mysqldump --databases hue --host=localhost --port=3306 -u hue -p &lt; hue-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原hive元数据</span></span><br><span class="line">mysqldump --databases metastore --host=localhost --port=3306 -u hive -p &lt; metastore-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原oozie</span></span><br><span class="line">mysqldump --databases oozie --host=localhost --port=3306 -u oozie -p &lt; oozie-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原sentry</span></span><br><span class="line">mysqldump --databases sentry --host=localhost --port=3306 -u sentry -p &lt; sentry-backup-`date +%F`-CDH6.0.0.sql</span><br></pre></td></tr></table></figure><p><strong>mysqldump恢复sentry库后，重启sentry失败，后来发现mysqldump没恢复成功，可以切换到sentry库下使用source恢复</strong></p></li><li><p>启动Sentry服务</p><p>通过CM直接启动Sentry服务</p></li><li><p>回滚Hue</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /opt/cloudera/parcels/CDH/lib/hue/app.reg</span><br><span class="line">cp -rp  /opt/cloudera/parcels_backup/app.reg-CM6.1.0-CDH6.0.0  /opt/cloudera/parcels/CDH/lib/hue/app.reg</span><br></pre></td></tr></table></figure></li><li><p>重新部署客户端配置</p><p><img src="images/rb11.png" alt></p></li><li><p>重启集群</p><p><img src="images/rb12.png" alt></p></li></ul><p><img src="images/rb13.png" alt></p><ul><li>回滚CDH版本后，会导致Oozie的共享库版本与CDH版本不匹配问题，需要降级Oozie的共享库</li></ul><p><img src="images/rb17.png" alt></p><p><img src="images/rb18.png" alt></p><p><img src="images/rb19.png" alt></p><p><img src="images/rb20.png" alt></p><p><img src="images/rb21.png" alt></p><p><img src="images/rb22.png" alt></p><p><img src="images/rb23.png" alt></p><h4 id="3-4-检查服务和数据"><a href="#3-4-检查服务和数据" class="headerlink" title="3.4.检查服务和数据"></a>3.4.检查服务和数据</h4><ul><li>Hue数据检查</li></ul><p>升级前的数据</p><p><img src="images/old.png" alt></p><p>回滚后的数据</p><p><img src="images/rb14.png" alt></p><p>创建表</p><p><img src="images/rb15.png" alt></p><p>插入数据</p><p><img src="images/rb16.png" alt></p><p><strong>至此CDH的回滚完成</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CDH6-0-0升级6-1-0步骤&quot;&gt;&lt;a href=&quot;#CDH6-0-0升级6-1-0步骤&quot; class=&quot;headerlink&quot; title=&quot;CDH6.0.0升级6.1.0步骤&quot;&gt;&lt;/a&gt;CDH6.0.0升级6.1.0步骤&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;h
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/CDH6.0.0update6.1.0/CDH6.0.0%E5%8D%87%E7%BA%A76.1.0%E6%AD%A5%E9%AA%A4/"/>
    <id>http://yoursite.com/2019/02/16/CDH6.0.0update6.1.0/CDH6.0.0升级6.1.0步骤/</id>
    <published>2019-02-16T15:32:13.079Z</published>
    <updated>2019-02-16T15:32:13.079Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CDH6-0-0升级6-1-0步骤"><a href="#CDH6-0-0升级6-1-0步骤" class="headerlink" title="CDH6.0.0升级6.1.0步骤"></a>CDH6.0.0升级6.1.0步骤</h2><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_overview.html" target="_blank" rel="noopener">官方文档</a></p><p><a href="https://cloud.tencent.com/developer/article/1077573" target="_blank" rel="noopener">参考文档</a></p><p>[TOC]</p><h3 id="1-CM升级"><a href="#1-CM升级" class="headerlink" title="1.CM升级"></a>1.CM升级</h3><h4 id="1-1-升级概述"><a href="#1-1-升级概述" class="headerlink" title="1.1.升级概述"></a>1.1.升级概述</h4><p><img src="images/cm01.png" alt></p><p>升级CDH集群，可以通过Cloudera Manager使用Cloudera parcels升级整个集群，也可以在所有群集主机使用基于RPM包的命令手动安装软件，然后Cloudera Manager完成服务升级。</p><p>可以不同时升级Cloudera Manager和CDH，但Cloudera Manager和CDH的版本必须兼容，Cloudera Manager的主要+次要版本等于或高于CDH的主要+次要版本。</p><h4 id="1-2-下载文件"><a href="#1-2-下载文件" class="headerlink" title="1.2.下载文件"></a>1.2.下载文件</h4><p><a href="https://archive.cloudera.com/cm6/" target="_blank" rel="noopener">CM6.1.0</a></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/" target="_blank" rel="noopener">北京IDC内网地址</a></p><h4 id="1-3-备份"><a href="#1-3-备份" class="headerlink" title="1.3.备份"></a>1.3.备份</h4><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_before.html" target="_blank" rel="noopener">官方文档</a></p><h5 id="1-3-1-收集信息"><a href="#1-3-1-收集信息" class="headerlink" title="1.3.1.收集信息"></a>1.3.1.收集信息</h5><ul><li>操作系统信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure><ul><li>查看数据库配置信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/cloudera-scm-server/db.properties</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/cloudera-scm-server/db.properties</span></span><br><span class="line"><span class="comment"># Auto-generated by scm_prepare_database.sh on Thu Dec  6 18:42:08 CST 2018</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For information describing how to configure the Cloudera Manager Server</span></span><br><span class="line"><span class="comment"># to connect to databases, see the "Cloudera Manager Installation Guide."</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">com.cloudera.cmf.db.type=mysql</span><br><span class="line">com.cloudera.cmf.db.host=localhost</span><br><span class="line">com.cloudera.cmf.db.name=scm</span><br><span class="line">com.cloudera.cmf.db.user=scm</span><br><span class="line">com.cloudera.cmf.db.setupType=EXTERNAL</span><br><span class="line">com.cloudera.cmf.db.password=scm</span><br></pre></td></tr></table></figure><h5 id="1-3-2-备份CM-Agent"><a href="#1-3-2-备份CM-Agent" class="headerlink" title="1.3.2.备份CM Agent"></a>1.3.2.备份CM Agent</h5><ul><li>创建备份目录 （在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CM_BACKUP_DIR=<span class="string">"`date +%F`-CM6.0.0"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CM_BACKUP_DIR</span></span><br><span class="line">mkdir -p <span class="variable">$CM_BACKUP_DIR</span></span><br></pre></td></tr></table></figure><blockquote><p>The tar commands in the steps below may return the following message. It is safe to ignore thismessage:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; tar: Removing leading `/&apos; from member names</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><ul><li>备份CM Agent当前运行状态（在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/cloudera-scm-agent.tar --exclude=*.sock /etc/cloudera-scm-agent /etc/default/cloudera-scm-agent /var/run/cloudera-scm-agent /var/lib/cloudera-scm-agent</span><br></pre></td></tr></table></figure><p><img src="images/cm02.png" alt></p><p><img src="images/cm03.png" alt></p><ul><li>备份yum源（在所有主机上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/repository.tar /etc/yum.repos.d</span><br></pre></td></tr></table></figure><p><img src="images/cm04.png" alt></p><h5 id="1-3-3-备份Cloudera-Management-Service"><a href="#1-3-3-备份Cloudera-Management-Service" class="headerlink" title="1.3.3.备份Cloudera Management Service"></a>1.3.3.备份Cloudera Management Service</h5><ul><li>在Service Monitor role 机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-service-monitor /var/lib/cloudera-service-monitor-`date +%F`-CM6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cm05.png" alt></p><ul><li>在Host Monitor role机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-host-monitor /var/lib/cloudera-host-monitor-`date +%F`-CM6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cm06.png" alt></p><ul><li>在 Event Server role机器上执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/cloudera-scm-eventserver /var/lib/cloudera-scm-eventserver-`date +%F`-CM6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cm07.png" alt></p><h5 id="1-3-4-停止CM相关服务"><a href="#1-3-4-停止CM相关服务" class="headerlink" title="1.3.4.停止CM相关服务"></a>1.3.4.停止CM相关服务</h5><ul><li>停止Cloudera Management Service</li></ul><p><strong>登录CM管理界面操作</strong></p><p><img src="images/cm08.png" alt></p><p><img src="images/cm09.png" alt></p><ul><li>停止Cloudera Manager Server （CM机器上执行）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop cloudera-scm-server</span><br></pre></td></tr></table></figure><p><img src="images/cm10.png" alt></p><h5 id="1-3-5-备份CM数据库（mysql机器上执行）"><a href="#1-3-5-备份CM数据库（mysql机器上执行）" class="headerlink" title="1.3.5.备份CM数据库（mysql机器上执行）"></a>1.3.5.备份CM数据库（mysql机器上执行）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --databases scm --host=localhost --port=3306 -u scm -p &gt; <span class="variable">$HOME</span>/scm-backup-`date +%F`-CM6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cm11.png" alt></p><h5 id="1-3-6-备份CM其他相关服务的数据库（mysql机器上执行）"><a href="#1-3-6-备份CM其他相关服务的数据库（mysql机器上执行）" class="headerlink" title="1.3.6.备份CM其他相关服务的数据库（mysql机器上执行）"></a>1.3.6.备份CM其他相关服务的数据库（mysql机器上执行）</h5><p><img src="images/cm12.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --databases am --host=localhost --port=3306 -u am -p &gt; <span class="variable">$HOME</span>/am-backup-`date +%F`-CM6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cm13.png" alt></p><h5 id="1-3-7-备份Cloudera-Manager-Server（CM机器上执行）"><a href="#1-3-7-备份Cloudera-Manager-Server（CM机器上执行）" class="headerlink" title="1.3.7.备份Cloudera Manager Server（CM机器上执行）"></a>1.3.7.备份Cloudera Manager Server（CM机器上执行）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf <span class="variable">$CM_BACKUP_DIR</span>/cloudera-scm-server.tar /etc/cloudera-scm-server /etc/default/cloudera-scm-server</span><br></pre></td></tr></table></figure><p><img src="images/cm14.png" alt></p><h4 id="1-4-升级Cloudera-Manager-Server"><a href="#1-4-升级Cloudera-Manager-Server" class="headerlink" title="1.4.升级Cloudera Manager Server"></a>1.4.升级Cloudera Manager Server</h4><ul><li>删除yum源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/cloudera*manager.repo*</span><br></pre></td></tr></table></figure><p><img src="images/cm15.png" alt></p><ul><li>添加新的yum源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/cloudera-manager.repo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[cloudera-repo]</span><br><span class="line">name=cloudera-repo</span><br><span class="line">baseurl=http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/redhat7/yum/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean  all</span><br><span class="line">rm -rf /var/cache/yum</span><br><span class="line">yum  repolist</span><br></pre></td></tr></table></figure><p><img src="images/cm16.png" alt></p><ul><li>停止cloudera-scm-agent服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop cloudera-scm-agent</span><br></pre></td></tr></table></figure><ul><li>升级CM</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent</span><br></pre></td></tr></table></figure><p><strong>如果弹出更新配置文件选项选择N</strong></p><blockquote><p>You might be prompted about your configuration file version:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configuration file &apos;/etc/cloudera-scm-agent/config.ini&apos;</span><br><span class="line">&gt; ==&gt; Modified (by you or by a script) since installation.</span><br><span class="line">&gt; ==&gt; Package distributor has shipped an updated version.</span><br><span class="line">&gt; What would you like to do about it ? Your options are:</span><br><span class="line">&gt; Y or I : install the package maintainer&apos;s version</span><br><span class="line">&gt; N or O : keep your currently-installed version</span><br><span class="line">&gt; D : show the differences between the versions</span><br><span class="line">&gt; Z : start a shell to examine the situation</span><br><span class="line">&gt; The default action is to keep your current version.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>You may receive a similar prompt for /etc/cloudera-scm-server/db.properties. Answer <strong>N</strong> to both prompts.</p><p>You may be prompted to accept the GPG key. Answer <strong>y</strong>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; Retrieving key from https://archive.cloudera.com/.../cm/RPM-GPG-KEY-cloudera</span><br><span class="line">&gt; Importing GPG key ...</span><br><span class="line">&gt;  Userid     : &quot;Yum Maintainer &lt;webmaster@cloudera.com&gt;&quot;</span><br><span class="line">&gt;  Fingerprint: ...</span><br><span class="line">&gt;  From       : https://archive.cloudera.com/.../RPM-GPG-KEY-cloudera</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p><img src="images/cm17.png" alt></p><ul><li>检查安装的包是否正确</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa <span class="string">'cloudera-manager-*'</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cloudera-manager-server-6.1.0-769885.el7.x86_64</span><br><span class="line">cloudera-manager-daemons-6.1.0-769885.el7.x86_64</span><br><span class="line">cloudera-manager-agent-6.1.0-769885.el7.x86_64</span><br></pre></td></tr></table></figure><p><img src="images/cm18.png" alt></p><ul><li>启动服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start cloudera-scm-agent</span><br><span class="line">systemctl start cloudera-scm-server</span><br></pre></td></tr></table></figure><ul><li>检查日志</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-server/cloudera-scm-server.log</span><br><span class="line">tail -f /var/<span class="built_in">log</span>/cloudera-scm-agent/cloudera-scm-agent.log</span><br></pre></td></tr></table></figure><p><img src="images/cm19.png" alt></p><ul><li>登录CM管理平台<a href="http://10.240.9.132:7180自动运行升级向导" target="_blank" rel="noopener">http://10.240.9.132:7180自动运行升级向导</a></li></ul><p><img src="images/cm21.png" alt></p><p><img src="images/cm22.png" alt></p><p>输入升级源</p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/" target="_blank" rel="noopener">http://10.240.9.132:8900/CDH6.1.0/cm/cm6/6.1.0/</a></p><p><img src="images/cm23.png" alt></p><p><img src="images/cm24.png" alt></p><p><img src="images/cm25.png" alt></p><p><img src="images/cm26.png" alt></p><p><img src="images/cm27.png" alt></p><p><img src="images/cm28.png" alt></p><p><img src="images/cm29.png" alt></p><p><img src="images/cm30.png" alt></p><p><img src="images/cm31.png" alt></p><p><img src="images/cm32.png" alt></p><p><img src="images/cm33.png" alt></p><p>Cloudera Manager在升级后报告过时的配置，请重新启动集群服务并重新部署客户端配置</p><p><img src="images/cm34.png" alt></p><p><img src="images/cm35.png" alt></p><p><img src="images/cm36.png" alt></p><p><img src="images/cm37.png" alt></p><ul><li><p>检查升级结果</p><p><strong>查看Cloudera Manager版本</strong></p></li></ul><p><img src="images/cm38.png" alt></p><p><img src="images/cm39.png" alt></p><p><strong>验证Agent是否向Cloudera Manager发送心跳</strong></p><p><img src="images/cm40.png" alt></p><p><strong>检查所有主机</strong></p><p><img src="images/cm41.png" alt></p><p><img src="images/cm42.png" alt></p><p><strong>查看检查结果</strong></p><p><img src="images/cm43.png" alt></p><p><strong>检查集群历史监控数据</strong></p><p><img src="images/cm44.png" alt></p><p><strong>至此CM升级成功。</strong></p><h3 id="2-CDH升级"><a href="#2-CDH升级" class="headerlink" title="2.CDH升级"></a>2.CDH升级</h3><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cdh_upgrade_before.html" target="_blank" rel="noopener">官方文档</a></p><h4 id="2-1-准备安装包"><a href="#2-1-准备安装包" class="headerlink" title="2.1.准备安装包"></a>2.1.准备安装包</h4><p><a href="https://archive.cloudera.com/cdh6/6.1.0/" target="_blank" rel="noopener">官方CDH6.1.0下载地址</a></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cdh/" target="_blank" rel="noopener">北京IDC内网地址</a></p><h4 id="2-2-服务检查"><a href="#2-2-服务检查" class="headerlink" title="2.2.服务检查"></a>2.2.服务检查</h4><ul><li>HDFS检查</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录任意一个节点，检查HDFS是否有错误，有错误修改后继续</span></span><br><span class="line">sudo -u hdfs hdfs fsck / -includeSnapshots</span><br><span class="line">sudo -u hdfs hdfs dfsadmin -report</span><br></pre></td></tr></table></figure><p><img src="images/cdh03.png" alt><img src="images/cdh04.png" alt></p><ul><li>HBase检查</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录任意一个DataNode节点，执行如下命令检查，有错误的话，修正错误后继续</span></span><br><span class="line">sudo -u hdfs hbase hbck</span><br></pre></td></tr></table></figure><p><img src="images/cdh05.png" alt></p><ul><li>KUDU检查</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行如下命令检查，有错误的话，修正错误后继续</span></span><br><span class="line"><span class="comment"># kudu kudu cluster ksck kudu_master_host1,ksck kudu_master_host2</span></span><br><span class="line">sudo -u kudu kudu cluster ksck bjds-bi-odp-prd-10-240-9-132-belle.lan</span><br></pre></td></tr></table></figure><p><img src="images/cdh06.png" alt></p><h4 id="2-3-停止服务"><a href="#2-3-停止服务" class="headerlink" title="2.3.停止服务"></a>2.3.停止服务</h4><p><img src="images/cdh01.png" alt></p><p><img src="images/cdh02.png" alt></p><h4 id="2-4-备份数据库"><a href="#2-4-备份数据库" class="headerlink" title="2.4.备份数据库"></a>2.4.备份数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份hue</span></span><br><span class="line">mysqldump --databases hue --host=localhost --port=3306 -u hue -p &gt; hue-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份hive元数据</span></span><br><span class="line">mysqldump --databases metastore --host=localhost --port=3306 -u hive -p &gt; metastore-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份oozie</span></span><br><span class="line">mysqldump --databases oozie --host=localhost --port=3306 -u oozie -p &gt; oozie-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 备份sentry</span></span><br><span class="line">mysqldump --databases sentry --host=localhost --port=3306 -u sentry -p &gt; sentry-backup-`date +%F`-CDH6.0.0.sql</span><br></pre></td></tr></table></figure><p><img src="images/cdh07.png" alt></p><p><img src="images/cdh08.png" alt></p><h4 id="2-5-备份ZooKeeper-所有节点"><a href="#2-5-备份ZooKeeper-所有节点" class="headerlink" title="2.5.备份ZooKeeper(所有节点)"></a>2.5.备份ZooKeeper(所有节点)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /var/lib/zookeeper/ /var/lib/zookeeper-backup-`date +%F`CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cdh09.png" alt></p><h4 id="2-6-备份数据"><a href="#2-6-备份数据" class="headerlink" title="2.6.备份数据"></a>2.6.备份数据</h4><ul><li>启用了HA的HDFS需要登录<strong>所有的JournalNode节点备份</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /data/dfs/jn /data/dfs/jn-CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><p><img src="images/cdh10.png" alt></p><ul><li>备份<strong>所有的NameNode节点</strong>运行状态</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/hadoop/conf.rollback.namenode</span><br><span class="line"><span class="built_in">cd</span> /var/run/cloudera-scm-agent/process/ &amp;&amp; <span class="built_in">cd</span> `ls -t1 | grep -e <span class="string">"-NAMENODE\$"</span> | head -1`</span><br><span class="line">cp -rp * /etc/hadoop/conf.rollback.namenode/</span><br><span class="line">rm -rf /etc/hadoop/conf.rollback.namenode/log4j.properties</span><br><span class="line">cp -rp /etc/hadoop/conf.cloudera.hdfs/log4j.properties /etc/hadoop/conf.rollback.namenode/</span><br></pre></td></tr></table></figure><p><img src="images/cdh11.png" alt></p><ul><li>备份NameNode的元数据（所有namenode主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -czvf <span class="variable">$CM_BACKUP_DIR</span>/nn_backup.tar.gz  /data/dfs/nn/</span><br></pre></td></tr></table></figure><p><img src="images/cdh13.png" alt></p><ul><li>备份<strong>所有的DataNode</strong>运行状态（所有运行DataNode主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/hadoop/conf.rollback.datanode/</span><br><span class="line"><span class="built_in">cd</span> /var/run/cloudera-scm-agent/process/ &amp;&amp; <span class="built_in">cd</span> `ls -t1 | grep -e <span class="string">"-DATANODE\$"</span> | head -1`</span><br><span class="line">cp -rp * /etc/hadoop/conf.rollback.datanode/</span><br><span class="line">rm -rf /etc/hadoop/conf.rollback.datanode/log4j.properties</span><br><span class="line">cp -rp /etc/hadoop/conf.cloudera.hdfs/log4j.properties /etc/hadoop/conf.rollback.datanode/</span><br></pre></td></tr></table></figure><p><img src="images/cdh12.png" alt></p><ul><li>备份Hue，所有的Hue Server主机</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在所有的Hue Server角色上运行</span></span><br><span class="line">mkdir -p /opt/cloudera/parcels_backup</span><br><span class="line">cp -rp /opt/cloudera/parcels/CDH/lib/hue/app.reg /opt/cloudera/parcels_backup/app.reg-CM6.1.0-CDH6.0.0</span><br></pre></td></tr></table></figure><h4 id="2-7-向集群中添加新版的CDH存储库"><a href="#2-7-向集群中添加新版的CDH存储库" class="headerlink" title="2.7.向集群中添加新版的CDH存储库"></a>2.7.向集群中添加新版的CDH存储库</h4><p><img src="images/cdh14.png" alt></p><p><img src="images/cdh18.png" alt></p><p><a href="http://10.240.9.132:8900/CDH6.1.0/cdh/" target="_blank" rel="noopener">http://10.240.9.132:8900/CDH6.1.0/cdh/</a></p><p><img src="images/cdh17.png" alt></p><h4 id="2-8-运行升级向导开始升级"><a href="#2-8-运行升级向导开始升级" class="headerlink" title="2.8.运行升级向导开始升级"></a>2.8.运行升级向导开始升级</h4><p><img src="images/cdh19.png" alt></p><p><img src="images/cdh20.png" alt></p><p><img src="images/cdh21.png" alt></p><p><img src="images/cdh22.png" alt></p><p><img src="images/cdh23.png" alt></p><p><img src="images/cdh24.png" alt></p><p><img src="images/cdh25.png" alt></p><p><img src="images/26.png" alt></p><p><img src="images/cdh27.png" alt></p><p><img src="images/cdh28.png" alt></p><h4 id="2-9-功能验证"><a href="#2-9-功能验证" class="headerlink" title="2.9.功能验证"></a>2.9.功能验证</h4><ul><li>运行一个MR任务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u hdfs hadoop jar  /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar  pi 10 100</span><br></pre></td></tr></table></figure><p><img src="images/cdh29.png" alt></p><p><img src="images/cdh30.png" alt></p><p><img src="images/cdh31.png" alt></p><ul><li>Hue测试</li></ul><p>检查原有数据</p><p>CDH6.0.0的数据</p><p><img src="images/old.png" alt></p><p>升级CDH6.1.0后的数据</p><p><img src="images/new.png" alt></p><p>创建数据库</p><p><img src="images/cdh33.png" alt></p><p>创建表和插入数据</p><p><img src="images/cdh34.png" alt></p><h4 id="2-10-最终化元数据升级"><a href="#2-10-最终化元数据升级" class="headerlink" title="2.10.最终化元数据升级"></a>2.10.最终化元数据升级</h4><p><strong>在最终化元数据之前，进行几天甚至几周的运行观察集群是否正常，在发现所有任务都没有任何异常情况后，再进行最终化元数据操作。一旦进行最终化元数据之后，就不能回滚到老的版本了，除非有数据备份。对NameNode的主备节点都执行最终化元数据升级操作：</strong></p><p><img src="images/cdh35.png" alt></p><h3 id="3-CDH回滚"><a href="#3-CDH回滚" class="headerlink" title="3.CDH回滚"></a>3.CDH回滚</h3><p><a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/install_rollback.html" target="_blank" rel="noopener">官方文档</a></p><p><a href="https://cloud.tencent.com/developer/article/1078827" target="_blank" rel="noopener">参考文档</a></p><h4 id="3-1-回滚限制"><a href="#3-1-回滚限制" class="headerlink" title="3.1.回滚限制"></a>3.1.回滚限制</h4><ul><li><strong>HDFS</strong> - 不能对进行过<strong>最终化元数据升级（2.10步骤）</strong>的HDFS集群进行回滚。</li><li><strong>集群升级后的配置变化将不会被保留</strong> - 包括升级后的角色、服务的变更。Cloudera 的建议是最终化元数据升级后再进行集群角色和服务的变更。</li><li><strong>HBase</strong> – If your cluster is configured to use HBase replication, data written to HBase after the upgrade might not be replicated to peers when you start your rollback. This topic does not describe how to determine which, if any, peers have the replicated data and how to roll back that data. For more information about HBase replication, see <a href="https://www.cloudera.com/documentation/enterprise/upgrade/topics/cdh_bdr_hbase_replication.html#topic_20_11" target="_blank" rel="noopener">HBase Replication</a>.</li><li><strong>Sqoop 1</strong> – Because of the changes introduced in Sqoop metastore logic, the metastore database that is created by the CDH 6.x version of Sqoop cannot be used by earlier versions.</li><li><strong>Sqoop 2</strong> – As described in the upgrade process, Sqoop2 had to be stopped and deleted before the upgrade process and therefore will not be available after the rollback.</li><li><strong>Kafka</strong> – Once the Kafka log format and protocol version configurations (the inter.broker.protocol.version and log.message.format.version properties) are set to the new version (or left blank, which means to use the latest version), <em>Kafka rollback is not possible</em>.</li></ul><h4 id="3-2-停止服务"><a href="#3-2-停止服务" class="headerlink" title="3.2.停止服务"></a>3.2.停止服务</h4><p><img src="images/cdh01.png" alt></p><p><img src="images/cdh02.png" alt></p><h4 id="3-3-回滚CDH"><a href="#3-3-回滚CDH" class="headerlink" title="3.3.回滚CDH"></a>3.3.回滚CDH</h4><ul><li>回滚Parcel</li></ul><p><img src="images/rb01.png" alt></p><p><img src="images/rb02.png" alt></p><p><img src="images/rb02-1.png" alt></p><p><img src="images/rb03.png" alt></p><p><strong>点击激活会弹出对话框，选择第二个选项，仅激活，如果不小心选择了第一个选项，开始下面步骤前，先停止服务。</strong></p><ul><li>还原ZooKeeper（所有主机）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /var/lib/zookeeper/</span><br><span class="line">cp -rp /var/lib/zookeeper-backup-`date +%F`CM6.1.0-CDH6.0.0 /var/lib/zookeeper</span><br></pre></td></tr></table></figure><p>通过CM启动zookeeper</p><ul><li><p>回滚HDFS</p><ul><li>对于开启了HA的HDFS回滚Journal Nodes</li></ul><ol><li><p>登录每个Journal Node节点主机，运行下面命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /data/dfs/jn/nameservice1/current/*</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rp /data/dfs/jn-CM6.1.0-CDH6.0.0/nameservice1/current/* /data/dfs/jn/nameservice1/current/</span><br></pre></td></tr></table></figure></li><li><p>通过CM启动JournalNodes角色</p><p><img src="images/rb04.png" alt></p></li></ol><p><img src="images/rb05.png" alt></p><p><img src="images/rb06.png" alt></p><ul><li><p>回滚 NameNode（NameNode角色主机执行）</p><ul><li><p>编辑<code>/etc/hadoop/conf.rollback.namenode/hdfs-site.xml</code>文件</p><p>a. 删除  <code>cloudera.navigator.client.config</code> 配置项</p><p>b. 删除<code>dfs.namenode.audit.loggers</code> 配置项</p><p>c. 按如下格式编辑 <code>dfs.hosts</code> 配置项 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original version of the dfs.hosts property:</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;dfs.hosts&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/var/run/cloudera-scm-agent/process/63-hdfs-NAMENODE/dfs_all_hosts.txt&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New version of the dfs.hosts property:</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;dfs.hosts&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/etc/hadoop/conf.rollback.namenode/dfs_all_hosts.txt&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>编辑<code>/etc/hadoop/conf.rollback.namenode/core-site.xml</code>文件，按如下格式修改<code>net.topology.script.file.name</code>配置项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original property</span></span><br><span class="line">&lt;property&gt;</span><br><span class="line">&lt;name&gt;net.topology.script.file.name&lt;/name&gt;</span><br><span class="line">&lt;value&gt;/var/run/cloudera-scm-agent/process/63-hdfs-NAMENODE/topology.py&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>按如下格式编辑<code>/etc/hadoop/conf.rollback.namenode/topology.py</code>文件的<code>MAP_FILE</code>项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAP_FILE = <span class="string">'/etc/hadoop/conf.rollback.namenode/topology.map'</span></span><br></pre></td></tr></table></figure></li><li><p>执行下面命令回滚:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.namenode namenode -rollback</span><br></pre></td></tr></table></figure><p><strong>有可能报错建立目录失败，手动建立下日志目录，并修改下目录权限777，然后执行回滚，回滚会提示是否需要回滚，选择Y，最后提前启动Namenode失败，继续执行下面步骤</strong></p></li><li><p>通过CM重启所有的NameNodes 和 JournalNodes 实例</p><p><img src="images/rb07.png" alt></p></li></ul></li><li><p>回滚DataNode</p><ul><li><p>编辑<code>/etc/hadoop/conf.rollback.datanode/hdfs-site.xml</code> 移除<code>dfs.datanode.max.locked.memory</code>属性</p></li><li><p>运行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/cloudera/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114/lib/hadoop/logs</span><br><span class="line">chmod 777 /opt/cloudera/parcels/CDH-6.0.0-1.cdh6.0.0.p0.537114/lib/hadoop/logs</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/hadoop/conf.rollback.datanode</span><br><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.datanode datanode -rollback</span><br></pre></td></tr></table></figure><p><img src="images/rb08.png" alt></p><p><img src="images/rb09.png" alt></p><p>回滚完成后通过<code>CTRL</code> + <code>C</code>返回终端</p><p><img src="images/rb10.png" alt></p></li><li><p>对于HA的HDFS，通过CM重启HDFS服务，非HA的HDFS重启所有的DataNode角色。</p></li><li><p>(非HA的HDFS回滚Secondary NameNode )If high availability is not enabled for HDFS, roll back the Secondary NameNode.</p><ol><li><p>(Clusters with TLS enabled only) Edit the<code>/etc/hadoop/conf.rollback.secondarynamenode/ssl-server.xml</code></p><p>file on all Secondary NameNode hosts (Located in the temporary rollback directory.) and update the keystore passwords with the actual cleartext passwords.</p><p>The passwords will have values that look like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;ssl.server.keystore.password&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;********&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;ssl.server.keystore.keypassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;********&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br></pre></td></tr></table></figure></li><li><p>(TLS only) Edit the /etc/hadoop/conf.rollback.secondarynamenode/ssl-server.xml file and remove the hadoop.security.credential.provider.path property.</p></li><li><p>Log in to the Secondary NameNode host and run the following commands:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /dfs/snn/*</span><br><span class="line">cd /etc/hadoop/conf.rollback.secondarynamenode/</span><br><span class="line">sudo -u hdfs hdfs --config /etc/hadoop/conf.rollback.secondarynamenode secondarynamenode -format</span><br></pre></td></tr></table></figure></li></ol><p>Restart the HDFS service. Open the Cloudera Manager Admin Console, go to the HDFS service page, and select Actions &gt; Restart.</p><p>The Restart Command page displays the progress of the restart. Wait for the page to display the Successfully restarted service message before continuing.</p></li></ul></li></ul></li><li><p>启动HBase服务</p><p>通过CM直接启动HBase服务</p></li><li><p>回滚数据库</p><ul><li>Hive Metastore</li><li>Hue</li><li>Oozie</li><li>Sentry Server</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还原hue</span></span><br><span class="line">mysqldump --databases hue --host=localhost --port=3306 -u hue -p &lt; hue-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原hive元数据</span></span><br><span class="line">mysqldump --databases metastore --host=localhost --port=3306 -u hive -p &lt; metastore-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原oozie</span></span><br><span class="line">mysqldump --databases oozie --host=localhost --port=3306 -u oozie -p &lt; oozie-backup-`date +%F`-CDH6.0.0.sql</span><br><span class="line"><span class="comment"># 还原sentry</span></span><br><span class="line">mysqldump --databases sentry --host=localhost --port=3306 -u sentry -p &lt; sentry-backup-`date +%F`-CDH6.0.0.sql</span><br></pre></td></tr></table></figure><p><strong>mysqldump恢复sentry库后，重启sentry失败，后来发现mysqldump没恢复成功，可以切换到sentry库下使用source恢复</strong></p></li><li><p>启动Sentry服务</p><p>通过CM直接启动Sentry服务</p></li><li><p>回滚Hue</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /opt/cloudera/parcels/CDH/lib/hue/app.reg</span><br><span class="line">cp -rp  /opt/cloudera/parcels_backup/app.reg-CM6.1.0-CDH6.0.0  /opt/cloudera/parcels/CDH/lib/hue/app.reg</span><br></pre></td></tr></table></figure></li><li><p>重新部署客户端配置</p><p><img src="images/rb11.png" alt></p></li><li><p>重启集群</p><p><img src="images/rb12.png" alt></p></li></ul><p><img src="images/rb13.png" alt></p><ul><li>回滚CDH版本后，会导致Oozie的共享库版本与CDH版本不匹配问题，需要降级Oozie的共享库</li></ul><p><img src="images/rb17.png" alt></p><p><img src="images/rb18.png" alt></p><p><img src="images/rb19.png" alt></p><p><img src="images/rb20.png" alt></p><p><img src="images/rb21.png" alt></p><p><img src="images/rb22.png" alt></p><p><img src="images/rb23.png" alt></p><h4 id="3-4-检查服务和数据"><a href="#3-4-检查服务和数据" class="headerlink" title="3.4.检查服务和数据"></a>3.4.检查服务和数据</h4><ul><li>Hue数据检查</li></ul><p>升级前的数据</p><p><img src="images/old.png" alt></p><p>回滚后的数据</p><p><img src="images/rb14.png" alt></p><p>创建表</p><p><img src="images/rb15.png" alt></p><p>插入数据</p><p><img src="images/rb16.png" alt></p><p><strong>至此CDH的回滚完成</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CDH6-0-0升级6-1-0步骤&quot;&gt;&lt;a href=&quot;#CDH6-0-0升级6-1-0步骤&quot; class=&quot;headerlink&quot; title=&quot;CDH6.0.0升级6.1.0步骤&quot;&gt;&lt;/a&gt;CDH6.0.0升级6.1.0步骤&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;h
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/02/16/CDH5.15%E4%B8%AD%E6%B7%BB%E5%8A%A0StreamSets%E6%9C%8D%E5%8A%A1/"/>
    <id>http://yoursite.com/2019/02/16/CDH5.15中添加StreamSets服务/</id>
    <published>2019-02-16T15:32:13.078Z</published>
    <updated>2019-02-16T15:32:13.079Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CDH中添加StreamSets服务"><a href="#CDH中添加StreamSets服务" class="headerlink" title="CDH中添加StreamSets服务"></a>CDH中添加StreamSets服务</h2><h3 id="1-安装准备"><a href="#1-安装准备" class="headerlink" title="1.安装准备"></a>1.安装准备</h3><p>下载安装包：<a href="https://archives.streamsets.com/index.html" target="_blank" rel="noopener">https://archives.streamsets.com/index.html</a> </p><p>下载如下三个文件：</p><ul><li><a href="https://archives.streamsets.com/datacollector/3.5.1/parcel/manifest.json" target="_blank" rel="noopener">manifest.json</a> </li><li><a href="https://archives.streamsets.com/datacollector/3.5.1/parcel/STREAMSETS_DATACOLLECTOR-3.5.1-el7.parcel" target="_blank" rel="noopener">Cloudera Parcels RHEL 7</a> ( <a href="https://archives.streamsets.com/datacollector/3.5.1/parcel/STREAMSETS_DATACOLLECTOR-3.5.1-el7.parcel.sha" target="_blank" rel="noopener">SHA</a>) (下载对应操作系统版本)（<strong>比较大，约4G左右，国内网速慢，建议使用代理</strong>）</li><li><a href="https://archives.streamsets.com/datacollector/3.5.1/csd/STREAMSETS-3.5.1.jar" target="_blank" rel="noopener">Custom Service Descriptor (CSD)</a> </li></ul><p><img src="images/streamsets/01.png" alt></p><h3 id="2-配置本地Parcels文件服务"><a href="#2-配置本地Parcels文件服务" class="headerlink" title="2.配置本地Parcels文件服务"></a>2.配置本地Parcels文件服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> soft</span><br><span class="line">python -m SimpleHTTPServer 8900</span><br><span class="line"></span><br><span class="line">Serving HTTP on 0.0.0.0 port 8900 ...</span><br></pre></td></tr></table></figure><p><img src="images/streamsets/02.png" alt></p><p><img src="images/streamsets/03.png" alt></p><h3 id="3-配置CSD"><a href="#3-配置CSD" class="headerlink" title="3.配置CSD"></a>3.配置CSD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将STREAMSETS-3.5.1.jar拷贝到/opt/cloudera/csd,并更改权限，然后重启cloudera-scm-server服务</span></span><br><span class="line">cp STREAMSETS-3.5.1.jar /opt/cloudera/csd</span><br><span class="line">chown cloudera-scm:cloudera-scm STREAMSETS-3.5.1.jar &amp;&amp;  chmod 644 STREAMSETS-3.5.1.jar</span><br><span class="line">/opt/cm-5.15.1/etc/init.d/cloudera-scm-server restart</span><br></pre></td></tr></table></figure><h3 id="4-下载分发激活Parcel包"><a href="#4-下载分发激活Parcel包" class="headerlink" title="4.下载分发激活Parcel包"></a>4.下载分发激活Parcel包</h3><p>在CM界面中点击Parcel &gt; 配置 &gt; 添加StreamSets的Parcel包路径，并保持修改 </p><p><img src="images/streamsets/04.png" alt></p><p><img src="images/streamsets/05.png" alt></p><p><strong>下载分发和激活(本文档省略该步骤，直接查看激活后的状态)</strong> </p><h3 id="5-添加StreamSets服务"><a href="#5-添加StreamSets服务" class="headerlink" title="5.添加StreamSets服务"></a>5.添加StreamSets服务</h3><p><img src="images/streamsets/06.png" alt></p><p><img src="images/streamsets/07.png" alt></p><p><img src="images/streamsets/08.png" alt></p><p><img src="images/streamsets/09.png" alt></p><p><img src="images/streamsets/10.png" alt></p><h3 id="6-登录"><a href="#6-登录" class="headerlink" title="6.登录"></a>6.登录</h3><p><img src="images/streamsets/11.png" alt></p><p><strong>默认的账户: admin 密码:admin</strong> </p><p><strong>至此StreamSets服务安装完毕</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CDH中添加StreamSets服务&quot;&gt;&lt;a href=&quot;#CDH中添加StreamSets服务&quot; class=&quot;headerlink&quot; title=&quot;CDH中添加StreamSets服务&quot;&gt;&lt;/a&gt;CDH中添加StreamSets服务&lt;/h2&gt;&lt;h3 id=&quot;1
      
    
    </summary>
    
    
  </entry>
  
</feed>
